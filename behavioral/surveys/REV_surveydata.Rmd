---
title: "REV Questionnaire Data"
author: "Krista DeStasio"
date: "10/7/2017"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, include=FALSE}
rm(list = ls())
#setwd("~/Desktop/REV_scripts/behavioral/surveys")

#The code assumes that this Markdown file is in the folder ~/REV_scripts/behavioral/surveys, and the folder structure follows the same hierarchical organization pattern (shown below in the Dir setups)

## Install and load required packages
list.of.packages <- c("stringr", "tidyverse", "reshape2", "ggplot2", "psych", "gridExtra", "knitr", "lme4", "memisc", "withr", "haven","rstudioapi")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if (length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, library, character.only = TRUE)

knitr::opts_chunk$set(fig.width = 12, fig.height = 8, fig.path = 'Figs/', echo = TRUE, warning = FALSE, message = FALSE)


#this is the only thing you should need to change
#homeBase = '~/Desktop/REV' # Brendan's path
#homeBase = '~/Dropbox/REV_repos' # Mel's path

homeBase <- selectDirectory(caption = "Select directory that contains REV_scripts folder", label = "Select", path = '~')


#In order to run this script, first set your working directory to wherever the current file is saved
setwd(paste0(homeBase,'/REV_scripts/behavioral/surveys'))

scriptDir = paste0(homeBase, '/REV_scripts/behavioral/')
catDir = paste0(scriptDir, '/REV_SST/info/')

idDir = paste0(homeBase,'/REV_BxData/')
dataDir = paste0(idDir, '/questionnaire_data/FromQualtrics/')
vecsDir = paste0(idDir, 'prc_mappings')

```

#Note: The data frame created does not contain all survey data. Will need to create a complete data frame in the future.
### Key:

**Key to variables in the screen_data data frame:**

- Gender: Male = 1, Female = 2  
- Use alcohol: 1 = yes, 2 = no  
- Make tobacco a factor 1 = yes, 2 = no  
- Self-control trouble with drugs: 1 = no, NA with score in subcategory = yes  
- Self-control trouble with food: 1 = no, NA with score in subcategory = yes  

```{r functions}
### function to get indices of various column names (based on scale prefixes)
#grepfun<- function(coln,df) grep(coln, colnames(df))
grepfun <- function(coln,df) {
  for (i in 1:length(coln)) {
    a <- grep(coln[i], colnames(df))
  }
  return(a)
}

### function to get the indices for a vector of variable column name prefixes
## useL = list of column name prefix strings
## outL = blank list object (where indices will be stored)
outL = findIndexInBL <- function(df, useL, outL,...) {
  for (a in 1:length(useL)) {
    x <- grepfun(useL[a], df)
    outL[[a]] <- x
  }
  return(outL)
}
```

```{r Import qualtrics data}
#categories <- as.data.frame(read.table("~/Desktop/REV_scripts/behavioral/REV_SST/info/participantCategories.txt"))
categories <- as.data.frame(read.table(paste0(catDir, "participantCategories.txt")))
colnames(categories) <- c("ID", "compltd.study", "num.categories", "food", "alcohol", "tobacco", "drugs")
categories <- categories[2:145,]

## General survey
#gen_survey <- as.data.frame(as.data.set(spss.system.file('~/Dropbox/REV/behavioral_data/questionnaire_data/FromQualtrics/REV_General_Survey.sav')))
gen_survey <- read_sav(paste0(dataDir, "REV_General_Survey.sav"))

## Baseline survey
#base_survey <- as.data.frame(as.data.set(spss.system.file('~/Dropbox/REV/behavioral_data/questionnaire_data/FromQualtrics/REV_Baseline_Survey.sav')))
base_survey <- read_sav(paste0(dataDir, "REV_Baseline_Survey.sav"))

## Screening data
#screen_data <- as.data.frame(read.csv('~/Dropbox/REV/behavioral_data/questionnaire_data/FromQualtrics/rev_screening.csv', stringsAsFactors = FALSE, skip = 1))
screen_data <- as.data.frame(read.csv(paste0(dataDir, "rev_screening.csv"), stringsAsFactors = FALSE, skip = 1))

```

```{r Screening data column names}
colnames(screen_data) = c('responseID', 'responseSet', 'name', 'extData', 'email', 'ip', 'status', 'start', 'end', 'finish', 'scoreSum', 'scoreWeightAvg', 'scoreWeightSD', 'ID', 'screener', 'date', 'instruct1', 'instruct2', 'instruct3', 'instruct4', 'otherStudies', 'ageRange', 'ineligible1', 'englishNative', 'englishFluent', 'ineligible2', 'handedness', 'ineligible3', 'gender', 'pregnant', 'ineligible4', 'instruct5', 'selfControlProblms', 'foods', 'chocolate', 'cookies', 'donuts', 'fries', 'iceCream', 'pasta', 'pizza', 'alcohol', 'tobacco', 'drugs', 'marijuana', 'heroin', 'meth', 'pills', 'cocaine', 'endorsed', 'ineligible5', 'dietRestrict', 'instruct6', 'ineligible6', 'instruct7', 'ineligible7', 'mentalHealth', 'instruct8', 'earlyAdverse', 'ineligible8', 'ineligible9', 'instruct9', 'SSRI', 'ineligible10', 'ineligible11', 'ineligible12', 'instruct10', 'MRI', 'instruct11', 'food1', 'food2', 'food3', 'food4', 'food5', 'alcohol1', 'alcohol2', 'alcohol3', 'alcohol4', 'alcohol5', 'tobacco1', 'tobacco2', 'tobacco3', 'tobacco4', 'tobacco5', 'drugs1', 'drugs2', 'drugs3', 'drugs4', 'drugs5', 'eligible', 'ineligible13', 'enroll', 'lat', 'long', 'acc', 'empty')

# Correct participant IDs (only for participants who were enrolled and later assigned subject IDs)
screen_data[89,14] = '0099'
screen_data[210,14] = '0265'
screen_data[300,14] = '0421'
screen_data[362, 14] = '0489'
screen_data[520, 14] = '0749'
screen_data[583, 14] = '0826'
screen_data[574, 14] = '0854'

# Remove duplicate screening rows (only for participants who were enrolled and later assigned subject IDs)
screen_data <- screen_data[-c(86, 198, 296, 514), ] # 0087, 0246, 0412, 0615
```

```{r Clean phone screening data, include=FALSE}
# Subset the screening data. Drop unneeded columns
screen_data <- dplyr::select(screen_data, scoreSum:enroll, -(contains('ineligible')), -(contains('instruct')), -(contains('Weight')), -(eligible), -(scoreSum))

# Pad the screening IDs with zeros to length four. Missing IDs will become 0000, improperly entered IDs will be corrected (e.g. 90 becomes 0090)
screen_data$ID <- withr::with_options(c(scipen = 999), str_pad(screen_data$ID, 4, pad = "0"))

# Screening IDs of participants who were assigned a study ID
screen_ID <- c('0014', '0016', '0028', '0004', '0012', '0030', '0033', '0011', '0034', '0119', '0139', '0142', '0060', '0041', '0149', '0156', '0083', '0088', '0092', '0115', '0099', '0194', '0130', '0055', '0198', '0183', '0166', '0165', '0180', '0177', '0191', '0218', '0220', '0224', '0246', '0223', '0255', '0286', '0291', '0263', '0261', '0452', '0276', '0280', '0257', '0362', '0243', '0396', '0349', '0265', '0326', '0420', '0329', '0328', '0301', '0338', '0365', '0345', '0357', '0459', '0247', '0421', '0353', '0376', '0381', '0378', '0454', '0380', '0400', '0506', '0479', '0488', '0412', '0515', '0505', '0583', '0493', '0489', '0524', '0513', '0527', '0526', '0540', '0582', '0553', '0638', '0575', '0615', '0596', '0560', '0721', '0610', '0679', '0682', '0686', '0660', '0693', '0087', '0687', '0685', '0661', '0664', '0740', '0749', '0698', '0944', '0735', '0746', '0757', '0826', '0783', '0995', '0779', '0774', '0943', '0802', '0765', '0809', '0797', '0816', '0819', '0868', '0974', '0823', '0837', '0848', '0830', '0854', '1005', '0873', '0967', '0890', '0916', '1013', '0972', '0923', '0983', '0986', '0952', '0985', '1001', '1042', NA, '1002')

# See which IDs are missing from screen_data (used to correct the IDs, should have no mismatches now since IDs corrected)
missing_IDs <- screen_ID[!screen_ID %in% screen_data$ID]

# Only keep data for participants who enrolled
screen_data <- screen_data[screen_data$ID %in% screen_ID, ]

idkey <- as.data.frame(read.csv(paste0(idDir, 'IDkey.csv'), header = TRUE, stringsAsFactors = FALSE))
names(idkey)[names(idkey) == "Screening.ID"] <- "ID" #rename screening ID as 'ID' to merge with screening_data df
idkey$ID <- withr::with_options(c(scipen = 999), str_pad(idkey$ID, 4, pad = "0")) #so they'll match up with the screen_data IDs

screen_data <- merge(idkey,screen_data, by = "ID")
screen_data <- screen_data[,c(2,32,35:54)] #only keep important screening data variables (including participant ID, *not* screening ID)
#screen_data <- dplyr::select(screen_data, -ID)

names(screen_data)[names(screen_data) == "Participant.ID"] <- "ID" #rename participant ID as 'ID' to merge with survey_data df later
screen_data$ID <- substring(screen_data$ID, 4) #get rid of 'REV' variable head (make IDs just 3-number codes so they'll match up with the base_survey and gen_survey IDs)

screen_data$ID <- as.factor(screen_data$ID)
#table(screen_data$ID)
```

```{r Cleaning_Across_DFs}

###Get rid of instruction variables
for (s in c("base_survey", "gen_survey")) {
  df <- get(s)
  #MM Note: Since I had to use haven to read in the data, my first step is converting the variable names to all lowercase (to match the rest of the code!)
  names(df) <- tolower(names(df))
  inst <- grepfun("_ins", df) #Instructions variable cols (to get rid of)
  df <- dplyr::select(df,-c(v1:v2,inst)) #because this part was done for all the survey cleanings
  assign(s, df)
}

```

```{r Clean base survey data}
## Truncate the data set to only columns that contain data
#base_survey <- dplyr::select(base_survey, -(v1:v2), -(v4:sc0_2), -(bscs_inst), -(bscs_h_ins), -(audit_inst), -(pacs_instr), -(bscs_inst))
base_survey <- dplyr::select(base_survey, -(v4:sc0_2)) #Column removal unique to this survey (I think?)

torename <- dplyr::select(base_survey, v3:demo_4)

colnames(torename) <- c('survey_ID', 'ID', 'probs_alcohol', 'probs_cocaine', 'probs_heroin', 'probs_marijuana', 'probs_meth', 'probs_pills', 'probs_tobacco', 'probs_chocolate', 'probs_cookies', 'probs_donuts', 'probs_fries', 'probs_icecream', 'probs_pasta', 'probs_pizza', 'gender', 'age', 'ethnicity', 'handedness')

base_survey <- cbind(torename, dplyr::select(base_survey, -(v3:demo_4)))

# Compare survey ID to manually entered ID & print those that do not match (baseline survey)

base_survey$survey_ID <- gsub("[^0-9]", "", base_survey$survey_ID) 
base_survey$ID <- gsub("[^0-9]", "", base_survey$ID) 

mismatch_ID <- base_survey$survey_ID != base_survey$ID

base_survey <- cbind(mismatch_ID, base_survey)

# See record of all problem IDs and corrections here: https://docs.google.com/spreadsheets/d/1Y9awcY7CsBBBFB1rKMZ_1UfrYxeo3hD9kJEFC58_lQk/edit#gid=368975328

# Correct mismatched participant IDs based on study records 

base_survey[7,2] = '014'
base_survey[9,2] = '013'
base_survey[11,2] = '001'
base_survey[14,2] = '005'
base_survey[43,2] = '050'
base_survey[87,2] = '086'
base_survey[94,2] = '088'
base_survey <- base_survey[-c(77,42,27,10),] # Remove duplicate survey for participants 039,031, 018
base_survey <- base_survey[,-c(1,2)] # drop the mismatch column & redundant survey_ID column

### I ran the below code multiple times while examining the data frame to find the problem IDs:
# Find duplicate manually entered IDs
#dups <-base_survey[duplicated(base_survey$ID)|duplicated(base_survey$ID, fromLast=TRUE),]
#View(dups)

# Find duplicate survey link IDs
#dups_link <-base_survey[duplicated(base_survey$survey_ID)|duplicated(base_survey$survey_ID, fromLast=TRUE),]
#View(dups_link)

base_survey <- merge(categories[,1:2], base_survey, by = "ID", all = TRUE)
```

```{r Clean general survey data}
# Truncate the data set to only columns that contain data
#gen_survey <- dplyr::select(gen_survey, -(v1:v2), -(v4:v10), -(fhh_inst), -(fhh_inst.0), -(fhh_inst.1), -(fhh_inst.2))
gen_survey <- dplyr::select(gen_survey, -c(v4:v10))

torename <- dplyr::select(gen_survey, v3:fhh_4)

colnames(torename) <- c('survey_ID', 'ID', 'month_born', 'year_born', 'state_born', 'gender', 'ethnicity', 'hispanic', 'education_lvl')

gen_survey <- cbind(torename, dplyr::select(gen_survey, -(v3:fhh_4)))

# Compare survey ID to manually entered ID & print those that do not match (general survey)

gen_survey$survey_ID <- gsub("[^0-9]", "", gen_survey$survey_ID) 
gen_survey$ID <- gsub("[^0-9]", "", gen_survey$ID) 

mismatch_ID <- gen_survey$survey_ID != gen_survey$ID

gen_survey <- cbind(mismatch_ID, gen_survey)

# See record of all problem IDs and corrections here: https://docs.google.com/spreadsheets/d/1Y9awcY7CsBBBFB1rKMZ_1UfrYxeo3hD9kJEFC58_lQk/edit#gid=368975328

# Correct mismatched participant IDs based on study records 

gen_survey[7,2] = '013'
gen_survey[9,2] = '001'
gen_survey[13,2] = '011'
gen_survey[21,2] = '005'
gen_survey[28,2] = '045'
gen_survey[30,2] = '014'
gen_survey[47,3] = '064'
gen_survey[24,2] = '064'
gen_survey[125,2] = '116'
gen_survey[135,3] = '144'

gen_survey <- gen_survey[-c(8, 14, 55, 39, 66, 146, 112),] # Remove duplicate survey for participants 018, 023, 031, 005, 045, 116, 118

gen_survey <- gen_survey[,-c(1,2)] # drop the mismatch column & redundant survey_ID column

### I ran the below code multiple times while examining the data frame to find the problem IDs:
# Find duplicate manually entered IDs
#dups <-gen_survey[duplicated(gen_survey$ID)|duplicated(gen_survey$ID, fromLast=TRUE),]
#View(dups)

# Find duplicate survey link IDs
#dups_link <-gen_survey[duplicated(gen_survey$survey_ID)|duplicated(gen_survey$survey_ID, fromLast=TRUE),]
#View(dups_link)

gen_survey <- merge(categories[,1:2], gen_survey, by = "ID", all = TRUE)
```

```{r Create a single data frame for base and gen surveys}
## Prep gender columns to be combined
#gen_survey$gender <- as.character(gen_survey$gender)
#base_survey$gender <- as.character(base_survey$gender)
gen_survey$gender <- as.character(as_factor(gen_survey$gender))
base_survey$gender <- as.character(as_factor(base_survey$gender)) #as_factor is from haven lib

gen_survey <- gen_survey %>% 
    mutate(gender = replace(gender, 
                         which(gender == 'female'), 'Female')) 
gen_survey <- gen_survey %>% 
    mutate(gender = replace(gender, 
                         which(gender == 'male'), 'Male')) 

## Change the values in the ethnicity column to the format used in the base survey so they match

# MM note to self: ethnicity categories are different in gen_survey and base_survey...
#gen_survey$ethnicity <- as.character(gen_survey$ethnicity)
#base_survey$ethnicity <- as.character(base_survey$ethnicity)
gen_survey$ethnicity <- as.character(as_factor(gen_survey$ethnicity))
gen_survey$hispanic <- as.character(as_factor(gen_survey$hispanic))

#gen_survey categories:
#  ethnicity = ["white" NA  "black" "american indian" "other"]
#  hispanic = ["no" NA "yes"]
base_survey$ethnicity <- as.character(as_factor(base_survey$ethnicity))

#base_survey categories:
#  ethnicity = ["White, not of Hispanic Origin" NA  "Hispanic"  "Black, not of Hispanic Origin" "American Indian or Alaskan Native" "Other"]
#  no hispanic category (since it's already in the ethnicity variable)

# For ethnicity columns where ethnicity = white and hispanic = no, White, not of Hispanic Origin
gen_survey <- gen_survey %>% 
    mutate(ethnicity = replace(ethnicity, 
                         which(ethnicity == 'white' & hispanic == 'no'), 'White, not of Hispanic Origin')) 

# For ethnicity columns where ethnicity = white and hispanic = yes, Hispanic
gen_survey <- gen_survey %>% 
    mutate(ethnicity = replace(ethnicity, 
                         which(ethnicity == 'white' & hispanic == 'yes'), 'Hispanic')) 

# White
gen_survey <- gen_survey %>% 
    mutate(ethnicity = replace(ethnicity, 
                         which(ethnicity == 'white'), 'White, not of Hispanic Origin')) #since the only white people still labelled 'white' are those with is.na(hispanic) 
base_survey <- base_survey %>% 
    mutate(ethnicity = replace(ethnicity, 
                         which(ethnicity == 'white'), 'White, not of Hispanic Origin')) 

# For ethnicity columns where ethnicity = black and hispanic = no, Black, not of Hispanic Origin
gen_survey <- gen_survey %>% 
    mutate(ethnicity = replace(ethnicity, 
                     which(ethnicity == 'black'), 'Black, not of Hispanic Origin')) # No participants "Black, Hispanic" based on base survey responses

gen_survey <- gen_survey %>% 
    mutate(ethnicity = replace(ethnicity, 
                         which(ethnicity == 'american indian'), 'American Indian or Alaskan Native'))

gen_survey <- gen_survey %>% 
    mutate(ethnicity = replace(ethnicity, 
                         which(ethnicity == 'other'), 'Other'))

# Replace missing gender and ethnicity values in the base_survey with those from the general survey
base_survey$ethnicity <- ifelse(test = is.na(base_survey$ethnicity), yes = gen_survey$ethnicity, no = base_survey$ethnicity)

base_survey$gender <- ifelse(test = is.na(base_survey$gender), yes = gen_survey$gender, no = base_survey$gender)

# Create the combined data frame 
survey_data <- merge(base_survey, gen_survey, by = 'ID', all = TRUE)

survey_data <- rename(survey_data, c("ethnicity.x" = "ethnicity", 
                                     "gender.x" = "gender", 
                                     "compltd.study.x" = "compltd_study"))

survey_data$ethnicity <- as.factor(survey_data$ethnicity)
survey_data$gender <- as.factor(survey_data$gender)

# Manually enter participants ages calculated based on year/month born and date survey taken
# ID : survey : birth  : age
# 103: 05-2016: 11-1979: 36
# 099: 04-2016: 05-1979: 36
# 096: 04-2016: 09-1961: 54
# 092: 02-2016: 09-1977: 38
# 087: 02-2016: 11-1076: 39
# 083: 01-2016: 11-1978: 37
# 081: 01-2016: 10-1962: 53
# 071: 12-2015: 12-1970: 45
# 061: 12-2015: 02-1980: 35
# 028: 08-2015: 05-1962: 53

survey_data[103, 18] = 36
survey_data[99, 18] = 36
survey_data[96, 18] = 54
survey_data[92, 18] = 38
survey_data[87, 18] = 39
survey_data[83, 18] = 37
survey_data[81, 18] = 53
survey_data[71, 18] = 45
survey_data[61, 18] = 35
survey_data[28, 18] = 53

# Manually enter missing category and gender data based on study notes & phone screening
survey_data[7,c(9,17)] = c(1, "Male") # Male, tobacco
survey_data[28,c(9, 7, 6)] = c(rep(1,3)) # tobacco, meth, marijuana
survey_data[61, c(9, 5, 7)] = c(rep(1,3)) #tobacco, heroin, meth
survey_data[71, c(9:11, 13:16, 6, 3)] = c(rep(1,9)) # chocolate, cookie, ice cream, pasta, pizza, fries, marijuana, alcohol, tobacco
survey_data[081, c(3, 9, 11, 13, 15, 16)] = c(rep(1,6)) #alcohol, tobacco, cookies, fries, pasta, pizza 
survey_data[083, c(9:12, 14:16)] = c(rep(1, 7)) # tobacco, chocolate, cookies, donuts, ice cream, pasta, pizza
survey_data[087, c(3, 14:16, 6)] = c(rep(1, 5)) # alcohol, ice cream, pasta, pizza, Marijuana
survey_data[092, c(6:8, 3)] = c(rep(1,4)) # Marijuana, meth, pills, alcohol
survey_data[096, c(10:14, 16)] = c(rep(1,6)) # chocolate, cookie, donut, fries, ice cream, pizza
survey_data[099, c(11:14, 16, 3, 9, 6, 8)] = c(rep(1,9)) # cookies, donuts, fries, pizza, ice cream, tobacco, alcohol, Marijuana, Pills
survey_data[103, c(6, 9:17)] = c(rep(1, 9), "Male") # Marijuana, chocolate, cookies, donuts, fries, ice cream, pasta, pizza, tobacco
survey_data[139, c(11, 12, 14:17)] = c(rep(1, 5), "Male") # cookies, donuts, ice cream, pasta, pizza

cols <- colnames(dplyr::select(survey_data, starts_with("probs_")))

survey_data[cols] <- sapply(survey_data[cols], as.numeric)

# Add category information to the data frame
survey_data$categories <- as.numeric(categories$num.categories) # The number of major categories the participant endorsed (options were: food, tobacco, drugs, alcohol)

survey_data$subcategories <- rowSums(survey_data[,c(3:16)], na.rm = TRUE) # The total different categories of images a participant saw

survey_data <- survey_data[-143,] # ID 143 was not assigned to a participant

# Make the endorsed categories variables into factors
for (col in cols) {
    survey_data[col][is.na(survey_data[col])] <- 0
}
survey_data[cols] <-
  lapply(survey_data[cols], factor,
         levels = c(0,1),
         labels = c("no", "yes"))

survey_data$compltd_study <- droplevels(survey_data$compltd_study) #because there were a couple of funky factor levels with no cases
survey_data$compltd_study <- 
  factor(survey_data$compltd_study, 
         levels = c(0,1),
         labels = c("no","yes"))

survey_data <- dplyr::select(survey_data, -(compltd.study.y), -(gender.y:hispanic), -starts_with("location"))

# Use participant ID to add screening data to 'survey_data'
survey_data <- merge(survey_data, screen_data, by = "ID")


survey_data$ID <- droplevels(survey_data$ID)
```

FROM SCREEN_DATA:
food1-5
alcohol1-5
tobacco1-5
drugs1-5

Scale: 1not at all - 5very much

1. I am good at resisting ___. 
2. I have a hard time breaking the habit of using ___.
3. I use ___ if it is enjoyable.
4. ___ sometimes keeps me from getting work done.
5. Sometimes, I can't stop myself from using ___, even if I know it is wrong.


## The next two chunks will change NAs to '999' for questionnaires that are not associated with endorsed craving stimuli!
## This means that true NAs will now be coded 999 (though we can obviously change that again later)
```{r prep_variables_for_missing_check}
# rename incorrectly names FCI pizza and pasta variables
survey_data <- dplyr::rename(survey_data, fci_pa_2 = fci_pi_2,
        fci_pi_2 = fci_pi_2.0)


Vices <- colnames(dplyr::select(survey_data, starts_with("probs_")))
for (i in Vices) {
  assign(i, list())
}
ViceLS <- paste0(Vices,"L")

#First, get each survey associated with each vice indices for alcohol variables
probs_alcoholL <- c("BSCS_A", "DUH_A", "ACQ_SF_R", "AUDIT", "PACS")
probs_cocaineL <- c("BSCS_C", "DUH_C", "CCQ_Brief")
probs_heroinL <- c("BSCS_H", "DUH_H", "HCQ_SF")
probs_marijuanaL <- c("BSCS_Ma", "DUH_Ma", "MCQ_SF")
probs_methL <- c("BSCS_Me","DUH_Me", "MCIY")
probs_pillsL <- c("BSCS_P", "DUH_P", "CEQ_S_P")
probs_tobaccoL <- c("FTND", "QSU")
probs_chocolateL <- c("LE", "DEBQ", "FCI_Ch")
probs_cookiesL <- c("LE", "DEBQ", "FCI_Co")
probs_donutsL <- c("LE", "DEBQ", "FCI_D")
probs_friesL <- c("LE", "DEBQ", "FCI_F")
probs_icecreamL <- c("LE", "DEBQ", "FCI_I")
probs_pastaL <- c("LE", "DEBQ", "FCI_Pa")
probs_pizzaL <- c("LE", "DEBQ", "FCI_Pi")

#Then get all indices for the associated survey items
ct <- 1
for (v in Vices) {
  p <- get(v)
  l <- tolower(get(ViceLS[ct])) #list of 'starts_with'/grep-able column names associated with v (probs_*)
  p = findIndexInBL(survey_data,l,p)
  p <- unlist(p)
  assign(v, p[p > 20])
  ct <- ct + 1
  survey_data[p]
}

#CRAVING <- c("bscs","acq","pacs","ccq","hcq","mcq","mciy","ceq","qsu","fci")
#CONSUMPTION <- c("duh","audit", "ftnd","debq")

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#SMASH IT WITH A HAMMER method
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#alcohol
alcohol_crav <- c("bscs_a", "acq_sf_r", "pacs")
alcohol_use <- c("duh_a", "audit")

#drugs: cocaine, heroin, marijuana, meth, and pills
drug_crav <- c("bscs_c", "ccq_brief", "bscs_h", "hcq_sf", "bscs_ma", "mcq_sf", "bscs_me", "mciy", "bscs_p", "ceq_s_p")
drug_use <- c("duh_c", "duh_h", "duh_ma", "duh_me", "duh_p")

#tobacco
tobacco_crav <- c("qsu")
tobacco_use <- c("ftnd")

#food: chocolate, cookies, donuts, fries, ice cream, pasta, and pizsa
food_crav <- c("le", "fci_ch", "fci_co", "fci_d", "fci_f", "fci_i", "fci_pa", "fci_pi")
food_use <- c("debq")

cat_by_scale_type <- c("alcohol_crav","alcohol_use", "drug_crav", "drug_use", "tobacco_crav", "tobacco_use", "food_crav", "food_use")
for (c in 1:length(cat_by_scale_type)) {
  #assign(cat_by_scale_type[c], list())
  assign(cat_by_scale_type[c],paste0(get(cat_by_scale_type[c]),"_z_m"))
}

```

```{r replace_NAs}
#This is the chunk where we actually recode true NAs to '999'

#do the thing
for (v in 1:length(Vices)) {
  e <- Vices[v] #Name of problem endorsed
  p <- get(Vices[v]) #Indices of all items from scales that are associated with that problem
  print(paste0(e, ": ", get(ViceLS[v]))) #display the problem and name of associated scales (my own sanity check)
  for (i in p) {
    survey_data[i][is.na(survey_data[i]) & survey_data[e] == "no"] <- 999 #change real NAs to " "
    print(variable.names(survey_data[i]))
  }
} #print to double check that I've put the right variables together!


#Get number of items associated with each possible endorsed problem
for (v in Vices) {
  s <- length(get(v))
  assign(paste0(v,"_ct"),s)
}

ViceCT <- paste0(Vices,"_ct")

survey_data$PROBitemTally <- 0 #This is where we'll put each participants 'total possible problem-related items'

for (v in 1:length(Vices)) {
  e <- Vices[v]
  survey_data$PROBitemTally <- ifelse(survey_data[e] == "yes", survey_data$PROBitemTally + get(ViceCT[v]), survey_data$PROBitemTally)
}

#The last problem-specific item is column 202, so everyone should have answered 203-515
survey_data$itemTally <- survey_data$PROBitemTally + length(203:515) #Each participants' total number of items they should have responded to

```

```{r}
#Get subject-wise total NA counts
#The last problem-specific item is column 202, so everyone will have 203-515
survey_data$subNAcount <- apply(survey_data[,21:515], 1, function(x) sum(is.na(x))) #out of all items that should have been answered
survey_data$PROBsubNAcount <- apply(survey_data[,21:202], 1, function(x) sum(is.na(x))) #this is just for the problem variables

survey_data$itemTally <- as.numeric(survey_data$itemTally); survey_data$PROBitemTally <- as.numeric(survey_data$PROBitemTally)
survey_data <- survey_data %>% group_by() %>%
  mutate(subNAprop = subNAcount/itemTally, PROBsubNAprop = PROBsubNAcount/PROBitemTally)

```



# Participant Demographics 
(N = 143) enrolled

```{r Screening data descriptives}
kable(as.matrix(psych::describe(screen_data$earlyAdverse)), caption = "Early Adverse Events of Enrolled Participants")
#ACES <- screen_data[,c(1,31)]
ACES <- dplyr::select(survey_data, 1, earlyAdverse) #get participant ID and ACEs score
save(ACES, file = "ACES.Rda")
#colnames(screen_data)
```

```{r Qualtrics demographics}
# Sample size
kable(as.matrix(table(survey_data$compltd_study)), caption = "Completed the Study?")

# Get age
kable(as.matrix(psych::describe(survey_data$age)), caption = "Ages, All Participants")
kable(as.matrix(psych::describe(subset(survey_data, compltd_study == 'yes', select = age))), caption = "Ages, Final Sample")

ggplot(data = survey_data) + 
  geom_bar(mapping = aes(x = age, fill = compltd_study)) +
    ggtitle("Participant Attrition by Age")


# Get gender
kable(as.matrix(summary(survey_data$gender)), caption = "Gender, All Participants")
kable(as.matrix(summary(subset(survey_data, compltd_study == 'yes', select = gender))), caption = "Gender, Final Sample")

# Get cultural/ethnic background
kable(as.matrix(summary(survey_data$ethnicity)), caption = "Ethnic/Cultural Background, All Participants")
kable(as.matrix(summary(subset(survey_data, compltd_study == 'yes', select = ethnicity))), caption = "Ethnic/Cultural Background, Final Sample")

# How many categories were endorsed by the particpants
kable(as.matrix(psych::describe(survey_data$categories)), caption = "Endorsed Categories, All Participants")
kable(as.matrix(psych::describe(subset(survey_data, compltd_study == 'yes', select = categories))), caption = "Endorsed Categories, Final Sample")

ggplot(data = survey_data) + 
  geom_bar(mapping = aes(x = categories, fill = compltd_study)) +
    ggtitle("Participant Attrition by Number of Categories")

kable(as.matrix(psych::describe(survey_data$subcategories)), caption = "Endorsed Sub-categories, All Participants")
kable(as.matrix(psych::describe(subset(survey_data, compltd_study == 'yes', select = subcategories))), caption = "Endorsed Sub-categories, Final Sample")

ggplot(data = survey_data) + 
  geom_bar(mapping = aes(x = subcategories, fill = compltd_study)) +
    ggtitle("Participant Attrition by Number of Sub-categories")
```


```{r Scoring Base Survey HRB variables}

#reverse the thing
for (v in 1:length(Vices)) {
  e <- Vices[v] #Name of problem endorsed
  p <- get(Vices[v]) #Indices of all items from scales that are associated with that problem
  print(paste0(e, ": ", get(ViceLS[v]))) #display the problem and name of associated scales (my own sanity check)
  for (i in p) {
    survey_data[i][survey_data[i] == 999 & survey_data[e] == "no"] <- NA #change real NAs to "NA"
    print(variable.names(survey_data[i]))
  }
} #print to double check that I've put the right variables together!

###### Brief Substance Craving Scale (BSCS)
    # Alcohol (BSCS-A) = CRAVING
    # Cocaine (BSCS-C) = CRAVING
    # Heroin (BSCS-H) = CRAVING
    # Marijuana (BSCS-Ma) = CRAVING
    # Methamphetamine (BSCS-Me) = CRAVING
    # Prescription pills (BSCS-P) = CRAVING

# Isolate the BSCS items
bscs_cols <- colnames(survey_data[(grepfun("bscs_",survey_data))])
survey_data[bscs_cols] <- lapply(survey_data[bscs_cols], as.numeric)

# Creating the subscales
bscs_key_list <- list(alcohol = c("bscs_a_1","bscs_a_2","bscs_a_3"), cocaine = c("bscs_c_1","bscs_c_2","bscs_c_3"), heroin = c("bscs_h_1","bscs_h_2","bscs_h_3"), marijuana = c("bscs_ma_1" ,"bscs_ma_2","bscs_ma_3"), meth = c("bscs_me_1","bscs_me_2" ,"bscs_me_3"), pills = c("bscs_p_1","bscs_p_2","bscs_p_3"))

# Get subscale means
survey_data$bscs_a <- rowMeans(survey_data[,bscs_key_list[[1]]], na.rm = TRUE) # BSCS Alcohol items 1-3
survey_data$bscs_c <- rowMeans(survey_data[,bscs_key_list[[2]]], na.rm = TRUE) # BSCS Cocaine items 1-3
survey_data$bscs_h <- rowMeans(survey_data[,bscs_key_list[[3]]], na.rm = TRUE) # BSCS Heroin items 1-3
survey_data$bscs_ma <- rowMeans(survey_data[,bscs_key_list[[4]]], na.rm = TRUE) # BSCS Marijauana items 1-3
survey_data$bscs_me <- rowMeans(survey_data[,bscs_key_list[[5]]], na.rm = TRUE) # BSCS Meth items 1-3
survey_data$bscs_p <- rowMeans(survey_data[,bscs_key_list[[6]]], na.rm = TRUE) # BSCS Prescription Pills items 1-3
survey_data$bscs_a_numcrave <- as.numeric(survey_data$bscs_a_4_1) # BSCS Alcohol number of cravings in past 24 hrs
survey_data$bscs_c_numcrave <- as.numeric(survey_data$bscs_c_4_1) # BSCS Cocaine number of cravings in past 24 hrs
survey_data$bscs_h_numcrave <- as.numeric(survey_data$bscs_h_4_1) # BSCS Heroin number of cravings in past 24 hrs
survey_data$bscs_ma_numcrave <- as.numeric(survey_data$bscs_ma_4_1) # BSCS Marijuana number of cravings in past 24 hrs
survey_data$bscs_me_numcrave <- as.numeric(survey_data$bscs_me_4_1) # BSCS Meth number of cravings in past 24 hrs
survey_data$bscs_p_numcrave <- as.numeric(survey_data$bscs_p_4_1) # BSCS Presciption Pills number of cravings in past 24 hrs


###### Drug Use History (DUH)
    # Alcohol (DUH-A) = CONSUMPTION
    # Cocaine (DUH-C) = CONSUMPTION 
    # Marijuana (DUH-Ma) = CONSUMPTION
    # Prescription pills (DUH-P) = CONSUMPTION
    # DUH-H (Drug Use History-Heroin) = CONSUMPTION
    # DUH-Me (Drug Use History-Meth) = CONSUMPTION

# Isolate the DUH items
duh_cols <- colnames(survey_data[(grepfun("duh_",survey_data))])
survey_data[duh_cols] <- lapply(survey_data[duh_cols], as.numeric)

# Only use item 2: "On average, how many times per day do you use (drug)?"
survey_data$duh_a_avg_use_per_day <- survey_data$duh_a_2
survey_data$duh_c_avg_use_per_day <- survey_data$duh_c_2
survey_data$duh_h_avg_use_per_day <- survey_data$duh_h_2
survey_data$duh_ma_avg_use_per_day <- survey_data$duh_ma_2
survey_data$duh_me_avg_use_per_day <- survey_data$duh_me_2
survey_data$duh_p_avg_use_per_day <- survey_data$duh_p_2

###### Alcohol Craving Questionnaire-Short Form (ACQ-SF-R; Tiffany et al., 2000) = CRAVING

# Isolate the ACQ-SF-R items
acq_sf_r_cols <- colnames(survey_data[(grepfun("acq_sf_r_",survey_data))])
survey_data[acq_sf_r_cols] <- lapply(survey_data[acq_sf_r_cols], as.numeric)

# Specify reverse-scored items
reverse_cols = c("acq_sf_r_3","acq_sf_r_8","acq_sf_r_11")
survey_data[,reverse_cols] = 8 - survey_data[,reverse_cols] # Reverse score the acq_sf_r items in reverse_cols

# Calculate total score
survey_data$acq_sf_r_total <- rowMeans(survey_data[acq_sf_r_cols], na.rm = TRUE) # acq_sf_r_data total score

###### Alcohol Use Disorders Identification Test (AUDIT; Babor, de la Fuente, Saunders, & Grant, 1989) = CONSUMPTION

# Isolate the AUDIT items
audit_cols <- colnames(survey_data[(grepfun("audit_",survey_data))])
survey_data[audit_cols] <- lapply(survey_data[audit_cols], as.numeric)

# Calculate total score 
survey_data$audit_total <- rowMeans(survey_data[audit_cols], na.rm = TRUE) # audit total score

###### Penn Alcohol Craving Scale (PACS; Flannery, Volpicelli, & Pettinati, 1999) = CRAVING

# Isolate the pacs items
pacs_cols <- colnames(survey_data[(grepfun("pacs_",survey_data))])
survey_data[pacs_cols] <- lapply(survey_data[pacs_cols], as.numeric)

# Calculate total score 
survey_data$pacs_total <- rowMeans(survey_data[pacs_cols], na.rm = TRUE) # pacs total score

###### Cocaine Craving Questionnaire-Brief (CCQ-Brief; Tiffany, Singleton, Haertzen, & Henningfield, 1993) = CRAVING

# Isolate the ccq_brief items
ccq_brief_cols <- colnames(survey_data[(grepfun("ccq_brief_",survey_data))])
survey_data[ccq_brief_cols] <- lapply(survey_data[ccq_brief_cols], as.numeric)

# Specify reverse-scored items
reverse_cols = c("ccq_brief_4","ccq_brief_7")
survey_data[,reverse_cols] = 8 - survey_data[,reverse_cols] # Reverse score the ccq_brief items in reverse_cols

# Calculate total score
survey_data$ccq_brief_total <- rowMeans(survey_data[ccq_brief_cols], na.rm = TRUE) # ccq_brief total score

###### Heroin Craving Questionnaire-Short Form (HCQ-SF-14; Heinz, Schroeder, Epstein, Singleton, Heishman, & Preston, 2006) = CRAVING

# Isolate the hcq_sf_14 items
hcq_sf_14_cols <- colnames(survey_data[(grepfun("hcq_sf_14_",survey_data))])
survey_data[hcq_sf_14_cols] <- lapply(survey_data[hcq_sf_14_cols], as.numeric)

# Specify reverse-scored items
reverse_cols = c("hcq_sf_14_1","hcq_sf_14_5","hcq_sf_14_8","hcq_sf_14_9","hcq_sf_14_10","hcq_sf_14_14")
survey_data[,reverse_cols] = 8 - survey_data[,reverse_cols] # Reverse score the hcq_sf_14 items in reverse_cols

# Calculate total score
survey_data$hcq_sf_14_total <- rowMeans(survey_data[hcq_sf_14_cols], na.rm = TRUE) # hcq_sf_14 total score

###### Marijuana Craving Questionnaire-Short Form (MCQ-SF; Heishman, Evans, Singleton, Levin, Copersino, & Gorelick, 2009) = CRAVING

# Isolate the mcq_sf items
mcq_sf_cols <- colnames(survey_data[(grepfun("mcq_sf_",survey_data))])
survey_data[mcq_sf_cols] <- lapply(survey_data[mcq_sf_cols], as.numeric)

# Calculate total score
survey_data$mcq_sf_total <- rowMeans(survey_data[mcq_sf_cols], na.rm = TRUE) # mcq_sf total score

###### Meth Craving Intensity Yesterday (MCIY) = CRAVING (NOTE: Single item)

# Isolate the mciy items
mciy_cols <- colnames(survey_data[(grepfun("mciy_",survey_data))])

# Calculate total score
survey_data$mciy_total <- survey_data$mciy_4 # mcq_sf total score; NOTE: only a single item

###### Craving Experience Questionnaire (CEQ-S; Andrade et al., 2014)
    # Prescription pills (CEQ-S-P) = CRAVING

# Isolate the ceq_s_p_ items
ceq_s_p_cols <- colnames(survey_data[(grepfun("ceq_s_p_",survey_data))])
survey_data[ceq_s_p_cols] <- lapply(survey_data[ceq_s_p_cols], as.numeric)

# Calculate total score
survey_data$ceq_s_p_total <- rowMeans(survey_data[ceq_s_p_cols], na.rm = TRUE) # ceq_s total score

###### Fagerstrom Test for Nicotine Dependence (FTND; Heatherton, Frecker, & Fagerstrom, 1991) = CONSUMPTION

# Isolate the ftnd items
ftnd_cols <- colnames(survey_data[(grepfun("ftnd_",survey_data))])
survey_data[ftnd_cols] <- lapply(survey_data[ftnd_cols], as.numeric)

# recode the variables based on the scoring criteria
library(car)
survey_data$ftnd_1 <- recode(survey_data$ftnd_1, "1=0;2=1;3=2;4=3")
survey_data$ftnd_2 <- recode(survey_data$ftnd_2, "1=0;2=1")
survey_data$ftnd_3 <- recode(survey_data$ftnd_3, "2=0")
survey_data$ftnd_4 <- recode(survey_data$ftnd_4, "1=0;2=1;3=2;4=3")
survey_data$ftnd_5 <- recode(survey_data$ftnd_5, "1=0;2=1")
survey_data$ftnd_6 <- recode(survey_data$ftnd_6, "1=0;2=1")

# Calculate total score
survey_data$ftnd_total <- rowMeans(survey_data[ftnd_cols], na.rm = TRUE) # ftnd total score

###### Questionnaire of Smoking Urges-Brief (QSU-brief; Cox, Tiffany, & Christen, 2011) = CRAVING

# Isolate the qsu_brief items
qsu_cols <- colnames(survey_data[(grepfun("qsu_",survey_data))])
survey_data[qsu_cols] <- lapply(survey_data[qsu_cols], as.numeric)

# NOTE: This is a Likert scale that ranges from 1-7. However, the responses were incorrectly coded such that 6=8 and 7=9. Recode these below. 

survey_data[qsu_cols] <- lapply(survey_data[qsu_cols], FUN = function(X) recode(X, "8=6;9=7"))

# Calculate total score
survey_data$qsu_total <- rowMeans(survey_data[qsu_cols], na.rm = TRUE) # qsu total score

###### Dutch Eating Behavior Questionnaire (DEBQ; Van Strien, Frijters, Bergers, & Defares, 1986) = CONSUMPTION

# Isolate the debq items
debq_cols <- colnames(survey_data[(grepfun("debq_",survey_data))])
survey_data[debq_cols] <- lapply(survey_data[debq_cols], as.numeric)

# Specify reverse-scored items. NOTE: I've decided to reverse score all of the "Restraint" subscale items. One item (debq16) from the "External Eating" subscale is also reverse-scored.

# Restrained Eating. NOTE: REVERSE SCORE THESE
# 1, 3, 7, 9, 11, 13, 15, 17, 19, 
# 
# Emotional Eating
# None of these items were included
# 
# External Eating
# 2, 4, 5, 6, 8, 10, 12, 14, 16R*, 18, 20

# Specify reverse-scored items
reverse_cols = c("debq_1", "debq_3", "debq_7", "debq_9", "debq_11", "debq_13", "debq_15", "debq_17", "debq_19", "debq_16")
survey_data[,reverse_cols] = 6 - survey_data[,reverse_cols] # Reverse score the debq items in reverse_cols

# Calculate total score
survey_data$debq_total <- rowMeans(survey_data[debq_cols], na.rm = TRUE) # debq total score

###### Food craving inventory (FCI; White et al., 2002)* NOTE: There is a single item for "craving" and a single item for "liking"
    # Chocolate (FCI-Ch) = CRAVING
    # Cookies (FCI-Co) = CRAVING
    # Donuts (FCI-D) = CRAVING
    # French Fries (FCI-F) = CRAVING
    # Ice Cream (FCI-I) = CRAVING
    # Pasta (FCI-Pa) = CRAVING
    # Pizza (FCI-Pi) = CRAVING

# Isolate the fci items
# NOTE: _1 = Crave; _2 = Like
# NOTE: fci_pi_2 actually corresponds to fci_pa_2 (How much do you like pasta?); fci_pi_2.0 should actually be fci_pi_2 (How much do you like pizza?). This was fixed above, so these variables should show up correctly. 

# Rename the "fci_1" variables as "fci_crave"
survey_data$fci_ch_crave <- survey_data$fci_ch_1
survey_data$fci_co_crave <- survey_data$fci_co_1
survey_data$fci_d_crave <- survey_data$fci_d_1
survey_data$fci_f_crave <- survey_data$fci_f_1
survey_data$fci_i_crave <- survey_data$fci_i_1
survey_data$fci_pa_crave <- survey_data$fci_pa_1
survey_data$fci_pi_crave <- survey_data$fci_pi_1

# isolate fci crave items
fci_cols <- c("fci_ch_crave", "fci_co_crave", "fci_d_crave", "fci_f_crave", "fci_i_crave", "fci_pa_crave", "fci_pi_crave")

survey_data[fci_cols] <- lapply(survey_data[fci_cols], as.numeric)

# NOTE: We don't want a total score before z-scoring. We first want to z-score because not everyone who endorsed food as a main category were given the same FCI subscales. 

# # Calculate total score for craving
# survey_data$fci_crave_total <- rowMeans(survey_data[fci_cols], na.rm = TRUE) # fci craving total score
```


```{r Convert HRB scale means to z-scores}

# compile a list of the HRB variable names (raw scale means)
hrb_var_names <- c("bscs_a","bscs_c","bscs_h","bscs_ma","bscs_me","bscs_p","bscs_a_numcrave","bscs_c_numcrave","bscs_h_numcrave","bscs_ma_numcrave","bscs_me_numcrave","bscs_p_numcrave","duh_a_avg_use_per_day","duh_c_avg_use_per_day","duh_h_avg_use_per_day","duh_ma_avg_use_per_day","duh_me_avg_use_per_day","duh_p_avg_use_per_day","acq_sf_r_total","audit_total","pacs_total","ccq_brief_total","hcq_sf_14_total","mcq_sf_total","mciy_total","ceq_s_p_total","ftnd_total","qsu_total","debq_total","fci_ch_crave","fci_co_crave","fci_d_crave","fci_f_crave","fci_i_crave","fci_pa_crave","fci_pi_crave")  

# subset the HRB variables in the data frame
hrb_vars <- survey_data[,hrb_var_names]

# Convert all HRB variables (raw scale means) into z scores and save as a separate data frame
hrb_vars_z <- as.data.frame(lapply(hrb_vars, FUN = function(X) scale(X, center = TRUE, scale = TRUE)))

# Make a function to re-name variables with suffix "_z"
name_with_z <- function(x){
  new <- paste0(x,"_z")
  return(new)
}

# apply this function to the hrb variables
colnames(hrb_vars_z) <- lapply(colnames(hrb_vars_z), name_with_z)

# Look at the head of the data frame of z scores
head(hrb_vars_z)


### CHECK WITH ELLIOT ABOUT THIS!!!

# Since only 1 person filled out the heroin questionnaires, the z-scores show up as NaN's. Manually replace these with 0's, i.e. since the one person's raw score is also the mean, the z-score should be 0. 

# Merge the z-scored variables with the original survey_data data frame
survey_data <- as.data.frame(cbind(survey_data, hrb_vars_z))
```


```{r Creating intensity rating weighting vars}
# Score the intensity ratings from screening data (adapted 5-item BIS items)

# Food
food_intensity_cols <- c("food1", "food2", "food3", "food4", "food5")
survey_data[food_intensity_cols] <- lapply(survey_data[food_intensity_cols], as.numeric)

# reverse score the 1st item "I am good at resisting..."
survey_data$food1 <- 6 - survey_data$food1

# Calculate total score
survey_data$food_intensity <- rowMeans(survey_data[food_intensity_cols], na.rm = TRUE) 

# Drugs
drugs_intensity_cols <- c("drugs1", "drugs2", "drugs3", "drugs4", "drugs5")
survey_data[drugs_intensity_cols] <- lapply(survey_data[drugs_intensity_cols], as.numeric)

# reverse score the 1st item "I am good at resisting..."
survey_data$drugs1 <- 6 - survey_data$drugs1

# Calculate total score
survey_data$drugs_intensity <- rowMeans(survey_data[drugs_intensity_cols], na.rm = TRUE)

# Alcohol
alcohol_intensity_cols <- c("alcohol1", "alcohol2", "alcohol3", "alcohol4", "alcohol5")
survey_data[alcohol_intensity_cols] <- lapply(survey_data[alcohol_intensity_cols], as.numeric)

# reverse score the 1st item "I am good at resisting..."
survey_data$alcohol1 <- 6 - survey_data$alcohol1

# Calculate total score
survey_data$alcohol_intensity <- rowMeans(survey_data[alcohol_intensity_cols], na.rm = TRUE)

# Tobacco
tobacco_intensity_cols <- c("tobacco1", "tobacco2", "tobacco3", "tobacco4", "tobacco5")
survey_data[tobacco_intensity_cols] <- lapply(survey_data[tobacco_intensity_cols], as.numeric)

# reverse score the 1st item "I am good at resisting..."
survey_data$tobacco1 <- 6 - survey_data$tobacco1

# Calculate total score
survey_data$tobacco_intensity <- rowMeans(survey_data[tobacco_intensity_cols], na.rm = TRUE)

# Calculate total intensity rating points for each individual
survey_data$total_intensity_points <- rowSums(survey_data[,c("food_intensity","drugs_intensity","alcohol_intensity","tobacco_intensity")], na.rm = TRUE)

# Calculate the weighting variable for all 4 HRB categories
survey_data$weighting_var_food <- survey_data$food_intensity/survey_data$total_intensity_points

survey_data$weighting_var_drugs <- survey_data$drugs_intensity/survey_data$total_intensity_points

survey_data$weighting_var_alcohol <- survey_data$alcohol_intensity/survey_data$total_intensity_points

survey_data$weighting_var_tobacco <- survey_data$tobacco_intensity/survey_data$total_intensity_points

# combine weighting variables into single vector
hrb_weights <- as.data.frame(lapply(survey_data[c("weighting_var_alcohol", "weighting_var_drugs", "weighting_var_tobacco", "weighting_var_food")], as.numeric)) #NOTE: order is alcohol, drugs, tobacco, food

# Check that weighting vars sum to 1
sanity_check_weighting <- rowSums(survey_data[,c("weighting_var_alcohol","weighting_var_tobacco","weighting_var_food","weighting_var_drugs")], na.rm = TRUE)
```


```{r Calculate weighted average of z-scored HRB variables}

# Separate out variable names by the 4 main HRB categories

# alcohol
hrb_alcohol_vars <- survey_data[,c("bscs_a_z", "bscs_a_numcrave_z", "acq_sf_r_total_z", "pacs_total_z", "duh_a_avg_use_per_day_z", "audit_total_z")]

hrb_alcohol_crave <- survey_data[,c("bscs_a_z", "bscs_a_numcrave_z", "acq_sf_r_total_z", "pacs_total_z")]

hrb_alcohol_consumption <- survey_data[,c("duh_a_avg_use_per_day_z", "audit_total_z")]

# drugs
hrb_drugs_vars <- survey_data[,c("bscs_c_z", "ccq_brief_total_z", "bscs_h_z", "hcq_sf_14_total_z", "bscs_ma_z", "mcq_sf_total_z", "bscs_me_z", "mciy_total_z", "bscs_p_z", "ceq_s_p_total_z", "duh_c_avg_use_per_day_z", "duh_h_avg_use_per_day_z", "duh_ma_avg_use_per_day_z", "duh_me_avg_use_per_day_z", "duh_p_avg_use_per_day_z")]

hrb_drugs_crave <- survey_data[,c("bscs_c_z", "ccq_brief_total_z", "bscs_h_z", "hcq_sf_14_total_z", "bscs_ma_z", "mcq_sf_total_z", "bscs_me_z", "mciy_total_z", "bscs_p_z", "ceq_s_p_total_z")]

hrb_drugs_consumption <- survey_data[,c("duh_c_avg_use_per_day_z", "duh_h_avg_use_per_day_z", "duh_ma_avg_use_per_day_z", "duh_me_avg_use_per_day_z", "duh_p_avg_use_per_day_z")]

# tobacco
hrb_tobacco_vars <- survey_data[,c("qsu_total_z","ftnd_total_z")]

hrb_tobacco_crave <- survey_data[,c("qsu_total_z")]

hrb_tobacco_consumption <- survey_data[,c("ftnd_total_z")]

# food
hrb_food_vars <- survey_data[,c("fci_ch_crave_z", "fci_co_crave_z", "fci_d_crave_z", "fci_f_crave_z", "fci_i_crave_z", "fci_pa_crave_z", "fci_pi_crave_z","debq_total_z")]

hrb_food_crave <- survey_data[,c("fci_ch_crave_z", "fci_co_crave_z", "fci_d_crave_z", "fci_f_crave_z", "fci_i_crave_z", "fci_pa_crave_z", "fci_pi_crave_z")]

hrb_food_consumption <- survey_data[,"debq_total_z"]

### Define functions

## Make a function to multiply variables by weighting variable
weight.food.measures <- function(x){
  new <- x*survey_data$weighting_var_food
  return(new)
}

## Make a function to multiply variables by weighting variable
weight.drugs.measures <- function(x){
  new <- x*survey_data$weighting_var_drugs
  return(new)
}

## Make a function to multiply variables by weighting variable
weight.alcohol.measures <- function(x){
  new <- x*survey_data$weighting_var_alcohol
  return(new)
}
  
## Make a function to multiply variables by weighting variable
weight.tobacco.measures <- function(x){
  new <- x*survey_data$weighting_var_tobacco
  return(new)
}

## Make a function to re-name variables with suffix "_w" to indicated that it is a weighted variable
name.as.weighted <- function(x){
  new <- paste0(x,"_w")
  return(new)
}

# Multiply all food z-scored variables by food intensity weighting variable 
hrb_food_w <- as.data.frame(lapply(hrb_food_vars, FUN = function(X) weight.food.measures(X)))

## append "_w" to indicated weighted variables
colnames(hrb_food_w) <- lapply(colnames(hrb_food_w), FUN = function(X) name.as.weighted(X))

# Multiply all drugs z-scored variables by drugs intensity weighting variable 
hrb_drugs_w <- as.data.frame(lapply(hrb_drugs_vars, FUN = function(X) weight.drugs.measures(X)))

## append "_w" to indicated weighted variables
colnames(hrb_drugs_w) <- lapply(colnames(hrb_drugs_w), FUN = function(X) name.as.weighted(X))

# Multiply all alcohol z-scored variables by alcohol intensity weighting variable 
hrb_alcohol_w <- as.data.frame(lapply(hrb_alcohol_vars, FUN = function(X) weight.alcohol.measures(X)))

## append "_w" to indicated weighted variables
colnames(hrb_alcohol_w) <- lapply(colnames(hrb_alcohol_w), FUN = function(X) name.as.weighted(X))

# Multiply all tobacco z-scored variables by tobacco intensity weighting variable 
hrb_tobacco_w <- as.data.frame(lapply(hrb_tobacco_vars, FUN = function(X) weight.tobacco.measures(X)))

## append "_w" to indicated weighted variables
colnames(hrb_tobacco_w) <- lapply(colnames(hrb_tobacco_w), FUN = function(X) name.as.weighted(X))

# combine into single data frame
weighted_vars <- cbind(hrb_food_w,hrb_drugs_w,hrb_alcohol_w,hrb_tobacco_w)

# create separate data frame with ALL COMBINED CRAVE vars
weighted_crave_vars <- weighted_vars[,c("bscs_a_z_w", "bscs_a_numcrave_z_w", "acq_sf_r_total_z_w", "pacs_total_z_w", "bscs_c_z_w", "ccq_brief_total_z_w", "bscs_h_z_w", "hcq_sf_14_total_z_w", "bscs_ma_z_w", "mcq_sf_total_z_w", "bscs_me_z_w", "mciy_total_z_w", "bscs_p_z_w", "ceq_s_p_total_z_w", "qsu_total_z_w", "fci_ch_crave_z_w", "fci_co_crave_z_w", "fci_d_crave_z_w", "fci_f_crave_z_w", "fci_i_crave_z_w", "fci_pa_crave_z_w", "fci_pi_crave_z_w")]

# create separate data frame with ALL COMBINED CONSUMPTION vars
weighted_consumption_vars_combined <- weighted_vars[,c("duh_a_avg_use_per_day_z_w", "audit_total_z_w", "duh_c_avg_use_per_day_z_w", "duh_h_avg_use_per_day_z_w", "duh_ma_avg_use_per_day_z_w", "duh_me_avg_use_per_day_z_w", "duh_p_avg_use_per_day_z_w", "ftnd_total_z_w", "debq_total_z_w")]

# create separate data frame with FOOD CRAVE vars
weighted_crave_vars_food <- weighted_vars[,c("fci_ch_crave_z_w", "fci_co_crave_z_w", "fci_d_crave_z_w", "fci_f_crave_z_w", "fci_i_crave_z_w", "fci_pa_crave_z_w", "fci_pi_crave_z_w")]

# create separate data frame with DRUGS CRAVE vars
weighted_crave_vars_drugs <- weighted_vars[,c("bscs_c_z_w", "ccq_brief_total_z_w", "bscs_h_z_w", "hcq_sf_14_total_z_w", "bscs_ma_z_w", "mcq_sf_total_z_w", "bscs_me_z_w", "mciy_total_z_w", "bscs_p_z_w", "ceq_s_p_total_z_w")]

# create separate data frame with ALCOHOL CRAVE vars
weighted_crave_vars_alcohol <- weighted_vars[,c("bscs_a_z_w", "bscs_a_numcrave_z_w", "acq_sf_r_total_z_w", "pacs_total_z_w")]

# create separate data frame with TOBACCO CRAVE vars
weighted_crave_vars_tobacco <- weighted_vars[,"qsu_total_z_w"]

# create separate data frame with FOOD CONSUMPTION vars
weighted_consumption_vars_food <- weighted_vars[,"debq_total_z_w"]

# create separate data frame with DRUGS CONSUMPTION vars
weighted_consumption_vars_drugs <- weighted_vars[,c("duh_c_avg_use_per_day_z_w", "duh_h_avg_use_per_day_z_w", "duh_ma_avg_use_per_day_z_w", "duh_me_avg_use_per_day_z_w", "duh_p_avg_use_per_day_z_w")]

# create separate data frame with ALCOHOL CONSUMPTION vars
weighted_consumption_vars_alcohol <- weighted_vars[,c("duh_a_avg_use_per_day_z_w", "audit_total_z_w")]

# create separate data frame with TOBACCO CONSUMPTION vars
weighted_consumption_vars_tobacco <- weighted_vars[,"ftnd_total_z_w"]

# average across weighted z scores within category for craving 
weighted_crave_vars_food_avg <- rowMeans(weighted_crave_vars_food, na.rm= TRUE)
weighted_crave_vars_drugs_avg <- rowMeans(weighted_crave_vars_drugs, na.rm = TRUE)
weighted_crave_vars_alcohol_avg <- rowMeans(weighted_crave_vars_alcohol, na.rm = TRUE)
weighted_crave_vars_tobacco_avg <- weighted_crave_vars_tobacco # Only 1 measure

# then sum these averaged weighted z scores to create a single HRB CRAVING summary variable 

## To do this....
### 1. cbind weighted crave variables and create a separate vector with the same number of rows, all 0
weighted_craves_qc <- cbind(weighted_crave_vars_food_avg,weighted_crave_vars_drugs_avg,weighted_crave_vars_alcohol_avg,weighted_crave_vars_tobacco_avg)
naners<-matrix(0,dim(weighted_craves_qc)[1],1)

### 2. recode naners (0 var) to 99999 if all weighted_crave categories (columns) are NaNs for each subject
for (r in 1:dim(weighted_craves_qc)[1]) {
  if (all(is.na(weighted_craves_qc[r,]))) {
    naners[r,1] <- 99999 }else {
      naners[r,1] <- 0
    }
}

### 3. add naners to weighted_crave dataframe (hrb_crave_summary) as variable
hrb_crave_summary <- as.data.frame(weighted_craves_qc)
hrb_crave_summary$allNANs <- naners

### 4. get rowSums for hrb_crave_summary, and then change '99999' coding back to NaN
survey_data$hrb_crave_summary <- rowSums(hrb_crave_summary,na.rm = TRUE)
survey_data$hrb_crave_summary[survey_data$hrb_crave_summary == 99999] <- NaN


# average across weighted z scores within category for consumption 
weighted_consumption_vars_food_avg <- weighted_consumption_vars_food # Only 1 measure
weighted_consumption_vars_drugs_avg <- rowMeans(weighted_consumption_vars_drugs, na.rm = TRUE)
weighted_consumption_vars_alcohol_avg <- rowMeans(weighted_consumption_vars_alcohol, na.rm = TRUE)
weighted_consumption_vars_tobacco_avg <- weighted_consumption_vars_tobacco # Only 1 measure

# then sum these averaged weighted z scores to create a single HRB CRAVING summary variable 

## To do this....
### 1. cbind weighted crave variables and create a separate vector with the same number of rows, all 0
weighted_consumption_qc <- cbind(weighted_consumption_vars_food_avg,weighted_consumption_vars_drugs_avg,weighted_consumption_vars_alcohol_avg,weighted_consumption_vars_tobacco_avg)
naners2<-matrix(0,dim(weighted_consumption_qc)[1],1)

### 2. recode naners (0 var) to 99999 if all weighted_crave categories (columns) are NaNs for each subject
for (r in 1:dim(weighted_consumption_qc)[1]) {
  if (all(is.na(weighted_consumption_qc[r,]))) {
    naners2[r,1] <- 99999 }else {
      naners2[r,1] <- 0
    }
}

### 3. add naners to weighted_crave dataframe (hrb_crave_summary) as variable
hrb_consumption_summary <- as.data.frame(weighted_consumption_qc)
hrb_consumption_summary$allNANs <- naners2

### 4. get rowSums for hrb_crave_summary, and then change '99999' coding back to NaN
survey_data$hrb_consumption_summary <- rowSums(hrb_consumption_summary,na.rm = TRUE)
survey_data$hrb_consumption_summary[survey_data$hrb_consumption_summary == 99999] <- NaN

#old code, not functional:
#survey_data$hrb_consumption_summary <- rowSums(cbind(weighted_consumption_vars_food_avg,weighted_consumption_vars_drugs_avg,weighted_consumption_vars_alcohol_avg,weighted_consumption_vars_tobacco_avg), na.rm = TRUE)
```




### Self-report individual differences measures (related to self-regulation)

## Score the SConS questionnaire
```{r SConS scoring}
## Reverse coding items
# scons_cols <- colnames(survey_data[,450:462])
# survey_data[scons_cols] <-
#       lapply(survey_data[scons_cols], plyr::mapvalues,
#       from = c("Not at all 1", "2", "3", "4", "Very Much 5"),
#       to = c(1,2,3,4,5))

scons_cols <- colnames(survey_data[(grepfun("scons_",survey_data))])

reverse_cols = c("scons_2", "scons_3", "scons_4", "scons_5", "scons_7", "scons_9", "scons_10", "scons_12", "scons_13")
survey_data[scons_cols] <- 
  lapply(survey_data[scons_cols], as.numeric)
survey_data[,reverse_cols] = 6 - survey_data[,reverse_cols] # Reverse score the SConS items in reverse_cols

# isolate raw items with relevant items reverse scored for later PCA analysis
scons_pca_items <- survey_data[scons_cols]

survey_data$scons_total <- rowMeans(survey_data[scons_cols], na.rm = TRUE) # Total SConS score

# How many survey responses do we have? 114
table(!is.na(survey_data[,"scons_total"]))

# reliability
key_scons <- ifelse(scons_cols %in% reverse_cols, -1, 1)
omega_scons_tot <- omega(survey_data[scons_cols], key = key_scons)[[4]]

```

## Score the BIS questionnaire
```{r BIS soring}
## Reverse coding items
# bis_cols <- colnames(survey_data[,400:429])
# survey_data[bis_cols] <-
#       lapply(survey_data[bis_cols], plyr::mapvalues,
#       from = c("Rarely/Never", "Occasionally", "Often", "Almost Always/Always"),
#       to = c(1,2,3,4))

bis_cols <- colnames(survey_data[(grepfun("bis_",survey_data))])
bis_cols <- bis_cols[-grep('bas_',bis_cols)] #remove combined 'bisbas_' variable names from list

reverse_cols = c("bis_7", "bis_10", "bis_13","bis_19","bis_6", "bis_1", "bis_5","bis_8","bis_11", "bis_17", "bis_22", "bis_30")
survey_data[bis_cols] <- 
  lapply(survey_data[bis_cols], as.numeric)
survey_data[,reverse_cols] = 5 - survey_data[,reverse_cols] # Reverse score the bis items in reverse_cols

# isolate raw items with relevant items reverse scored for later PCA analysis
bis_pca_items <- survey_data[bis_cols]

## Creating the subscales
biskey_list <- list(attention = c("bis_4","bis_7","bis_10","bis_13","bis_16","bis_19","bis_24","bis_27"), motor = c("bis_2","bis_6","bis_9","bis_12","bis_15","bis_18","bis_21","bis_23","bis_26","bis_29"), non_planning = c("bis_1","bis_3","bis_5","bis_8","bis_11","bis_14","bis_17","bis_20","bis_22","bis_25","bis_28","bis_30"))

survey_data$bis_attn <- rowMeans(survey_data[,biskey_list[[1]]]) # bis attention score
survey_data$bis_motor <- rowMeans(survey_data[,biskey_list[[2]]]) # bis motor score
survey_data$bis_noplan <- rowMeans(survey_data[,biskey_list[[3]]]) # bis non-planning score
survey_data$bis_total <- rowMeans(survey_data[,c("bis_attn", "bis_motor", "bis_noplan")]) # bis total score

# How many survey responses do we have? 116
table(!is.na(survey_data[,"bis_total"]))

# reliability
key_bis <- ifelse(bis_cols %in% reverse_cols, -1, 1)
omega_bis_tot <- omega(survey_data[bis_cols], key = key_bis)[[4]]
```

## Score the BIS BAS questionnaire
```{r BIS BAS scoring}
# isolate the BIS BAS items
bis_bas_cols <- colnames(survey_data[(grepfun("bas_",survey_data))])

# specify reverse-scored items
# The only items that are reverse-scored are "bis_bas_5" and "bis_bas_7".
# NOTE: This scale should have been administered on a 1-4 scale (1=very true for me, 4=very false for me), where higher raw scores indicate lower amounts of the construct measured. Instead, it was administered on a 1-5 scale (1=strongly disagree, 5=strongly agree), where higher raw scores indicate higher amounts of the construct measured. Normally, all items except 5 and 7 are reverse-scored, but in our case we must reverse that. 

reverse_cols = bis_bas_cols[c(5,7)]

survey_data[bis_bas_cols] <- 
  lapply(survey_data[bis_bas_cols], as.numeric)

# reverse score the relevant items
survey_data[,reverse_cols] = 6 - survey_data[,reverse_cols] # Reverse score the BISBAS items in reverse_cols

# isolate raw items with relevant items reverse scored for later PCA analysis
bis_bas_pca_items <- survey_data[bis_bas_cols]

# NOTE: These item numberings are unique to the version administered in REV. I had to cross-check them with the published scoring, found here: http://www.psy.miami.edu/faculty/ccarver/sclBISBAS.html

# BAS Drive: 4, 11, 13, 15
# BAS Fun Seeking: 3, 10, 17, 20
# BAS Reward Responsiveness: 1, 6, 8, 16, 19
# BIS: 2, 5, 7, 9, 12, 14, 18

bis_bas_key_list <- list(bas_drive = c("bis_bas_4","bis_bas_11","bis_bas_13","bis_bas_15"), bas_fun = c("bis_bas_3","bis_bas_10","bis_bas_17","bis_bas_20"), bas_reward = c("bis_bas_1","bis_bas_6", "bis_bas_8","bis_bas_16","bis_bas_19"), bis = c("bis_bas_2","bis_bas_5","bis_bas_7","bis_bas_9", "bis_bas_12","bis_bas_14","bis_bas_18"))

survey_data$bis_bas_bas_drive <- rowMeans(survey_data[,bis_bas_key_list[[1]]]) # BAS Drive
survey_data$bis_bas_bas_fun <- rowMeans(survey_data[,bis_bas_key_list[[2]]]) # BAS Fun Seeking
survey_data$bis_bas_bas_reward <- rowMeans(survey_data[,bis_bas_key_list[[3]]]) # BAS Reward Responsiveness
survey_data$bis_bas_bas_total <- rowMeans(survey_data[,c("bis_bas_bas_drive", "bis_bas_bas_fun", "bis_bas_bas_reward")]) # BAS total
survey_data$bis_bas_bis_total <- rowMeans(survey_data[,bis_bas_key_list[[4]]]) # BIS

# # How many survey responses do we have?
# table(!is.na(survey_data[,"bis_bas_bis_total"]))          
```

## Score the UPPS questionnaire
```{r UPPS Scoring}

# NOTE: Whoever entered the scale skipped "upps_p_47", so we need to rename the variables from "upps_p_48" on. Rename incorrectly named variables below.
colnames(survey_data)[colnames(survey_data) == "upps_p_48"] <- "upps_p_47"
colnames(survey_data)[colnames(survey_data) == "upps_p_49"] <- "upps_p_48"
colnames(survey_data)[colnames(survey_data) == "upps_p_50"] <- "upps_p_49"
colnames(survey_data)[colnames(survey_data) == "upps_p_51"] <- "upps_p_50"
colnames(survey_data)[colnames(survey_data) == "upps_p_52"] <- "upps_p_51"
colnames(survey_data)[colnames(survey_data) == "upps_p_53"] <- "upps_p_52"
colnames(survey_data)[colnames(survey_data) == "upps_p_54"] <- "upps_p_53"
colnames(survey_data)[colnames(survey_data) == "upps_p_55"] <- "upps_p_54"
colnames(survey_data)[colnames(survey_data) == "upps_p_56"] <- "upps_p_55"
colnames(survey_data)[colnames(survey_data) == "upps_p_57"] <- "upps_p_56"
colnames(survey_data)[colnames(survey_data) == "upps_p_58"] <- "upps_p_57"
colnames(survey_data)[colnames(survey_data) == "upps_p_59"] <- "upps_p_58"
colnames(survey_data)[colnames(survey_data) == "upps_p_60"] <- "upps_p_59"
 
# Isolate the UPPS items
upps_cols <- colnames(survey_data[(grepfun("upps_",survey_data))])

# NOTE: The published scale has 1-4 Likert scale where 1=Agree Strongly, 4=Disagree Strongly. However, it was administered with the opposite Likert rating, i.e. 1=Disagree Strongly, 4=Agree Strongly. Thus, we need to follow the opposite of the published reverse scoring.  

# specify reverse-scored items
reverse_cols =c("upps_p_54","upps_p_1","upps_p_6","upps_p_11","upps_p_16","upps_p_21","upps_p_28","upps_p_33","upps_p_38","upps_p_43","upps_p_48","upps_p_49","upps_p_4","upps_p_14","upps_p_19","upps_p_24","upps_p_27","upps_p_32","upps_p_37","upps_p_42")

# # these are the reverse items if we had used the original Likert Scale
# reverse_cols = c("upps_p_2","upps_p_7","upps_p_12","upps_p_17","upps_p_22","upps_p_29","upps_p_34","upps_p_39","upps_p_44","upps_p_51","upps_p_58","upps_p_9","upps_p_47","upps_p_3","upps_p_8","upps_p_13","upps_p_18","upps_p_23","upps_p_26","upps_p_31","upps_p_36","upps_p_41","upps_p_46","upps_p_52","upps_p_56","upps_p_5","upps_p_10","upps_p_15","upps_p_20","upps_p_25","upps_p_30","upps_p_35","upps_p_40","upps_p_45","upps_p_50","upps_p_53","upps_p_55","upps_p_57","upps_p_59")

survey_data[upps_cols] <- 
  lapply(survey_data[upps_cols], as.numeric)

# reverse score the relevant items
survey_data[,reverse_cols] = 5 - survey_data[,reverse_cols] # Reverse score the UPPS items in reverse_cols

# isolate raw items with relevant items reverse scored for later PCA analysis
upps_pca_items <- survey_data[upps_cols]

# (Negative) Urgency: 2,7,12,17,22,29,34,39,44,51,54,58
# (lack of) Premeditation: 1,6,11,16,21,28,33,38,43,48,49
# (lack  of) Perseverance: 4,9,14,19,24,27,32,37,42,47
# Sensation Seeking:  3,8,13,18,23,26,31,36,41,46,52,56
# Positive  Urgency:  5,10,15,20,25,30,35,40,45,50,53,55,57,59  

upps_key_list <- list(upps_neg_urg = c("upps_p_2","upps_p_7","upps_p_12","upps_p_17","upps_p_22","upps_p_29","upps_p_34","upps_p_39","upps_p_44","upps_p_51","upps_p_54","upps_p_58"), upps_lack_premed = c("upps_p_1","upps_p_6","upps_p_11","upps_p_16","upps_p_21","upps_p_28","upps_p_33","upps_p_38","upps_p_43","upps_p_48","upps_p_49"), upps_lack_persev = c("upps_p_4","upps_p_9","upps_p_14","upps_p_19","upps_p_24","upps_p_27","upps_p_32","upps_p_37","upps_p_42","upps_p_47"), upps_sens_seek = c("upps_p_3","upps_p_8","upps_p_13","upps_p_18","upps_p_23","upps_p_26","upps_p_31","upps_p_36","upps_p_41","upps_p_46","upps_p_52","upps_p_56"), upps_pos_urg = c("upps_p_5","upps_p_10","upps_p_15","upps_p_20","upps_p_25","upps_p_30","upps_p_35","upps_p_40","upps_p_45","upps_p_50","upps_p_53","upps_p_55","upps_p_57","upps_p_59"))

survey_data$upps_neg_urg <- rowMeans(survey_data[,upps_key_list[[1]]]) # UPPS (Negative) Urgency
survey_data$upps_lack_premed <- rowMeans(survey_data[,upps_key_list[[2]]]) # UPPS (lack of) Premeditation
survey_data$upps_lack_persev <- rowMeans(survey_data[,upps_key_list[[3]]]) # UPPS (lack of) Perseverance
survey_data$upps_sens_seek <- rowMeans(survey_data[,upps_key_list[[4]]]) # UPPS Sensation Seeking
survey_data$upps_pos_urg <- rowMeans(survey_data[,upps_key_list[[5]]]) # UPPS Positive  Urgency
```


## Perform data reduction on individual differences vars (SconS, BIS, BISBAS)
```{r PCA without using na.omit}
# create data frame with all vars that will be used for PCA. These are raw scale items and the relevant items have been reverse scored. 

all_pca_vars <- cbind(scons_pca_items,bis_pca_items,bis_bas_pca_items) 

# get correlation matrix of raw scale items
orig.cor <- cor(all_pca_vars, use="pairwise.complete.obs") %>%
  round(2)

# create heat map of raw correlations
melted_cormat <- melt(orig.cor)

ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()

# Unrotated PCA
pca <- princomp(na.omit(all_pca_vars), cor=TRUE)

# View Scree plot of eigenvalues
plot(pca,type="lines", main="Scree Plot") # use first 3 components

# View eigenvalues
eigens <- eigen(orig.cor)
#View(eigens$values) # these are the original (unrotated) eigenvalues

# PCA with oblique rotation
pca.oblique <- principal(all_pca_vars, rotate="promax", nfactors = 3, missing=TRUE)
summary(pca.oblique)
pca.oblique$loadings 

# PCA with orthogonal rotation. NOTE: Using this method.
pca.orthogonal <- principal(all_pca_vars, rotate="varimax", nfactors = 3, missing=TRUE)
summary(pca.orthogonal)
pca.orthogonal$loadings 

# save 3 components as variables
survey_data$pca_impulse <- pca.orthogonal$scores[,1]
survey_data$pca_nonplanning <- pca.orthogonal$scores[,2]
survey_data$pca_neg_anticipation <- pca.orthogonal$scores[,3]

# correlate these 3 components to make sure they don't highly correlate 
pca_cor_matrix <- rcorr(as.matrix(survey_data[,c("pca_impulse", "pca_nonplanning", "pca_neg_anticipation")]), type = "pearson")
pca_cor_matrix
```


```{r PCA using na.omit}
### # NOTE: Doing list-wise deletion on this data frame (na.omit).
# Use this if you want to omit IDs with no corresponding survey data
all_pca_vars_omitted <- cbind(scons_pca_items,bis_pca_items,bis_bas_pca_items) %>% na.omit()

# PCA with orthogonal rotation
pca.orthogonal_omitted <- principal(all_pca_vars_omitted, rotate="varimax", nfactors = 3, missing=TRUE)
summary(pca.orthogonal_omitted)
pca.orthogonal_omitted$loadings

# Save row indices of pca scores as an ID variable in a new data frame
pca.orthogonal_omitted_scores <- rownames_to_column(as.data.frame(pca.orthogonal_omitted$scores), var = "ID")

# convert both ID vars to character
survey_data$ID <- as.character(survey_data$ID)
pca.orthogonal_omitted_scores$ID <- as.character(pca.orthogonal_omitted_scores$ID)

# Make ID in pca.orthogonal_omitted$scores same format as in survey_data
fixID <- function(df) {
  for (i in 1:length(df$ID)) {
    if(nchar(df$ID[i]) == 1) {
      placeholder <- "00"
    } else if (nchar(df$ID[i]) == 2) {
      placeholder <- "0"
    } else {
      placeholder <-  ""
    }
  df$ID[i] <- as.character(paste0(placeholder, df$ID[i]))
  }
  return(df$ID)
}

pca.orthogonal_omitted_scores$ID <- fixID(pca.orthogonal_omitted_scores)

# save 3 components as variables
pca.orthogonal_omitted_scores$pca_impulse_omitted <- pca.orthogonal_omitted_scores[,2]
pca.orthogonal_omitted_scores$pca_nonplanning_omitted <- pca.orthogonal_omitted_scores[,3]
pca.orthogonal_omitted_scores$pca_neg_anticipation_omitted <- pca.orthogonal_omitted_scores[,4]

# correlate these 3 components to make sure they don't highly correlate 
pca_cor_matrix_omitted <- rcorr(as.matrix(pca.orthogonal_omitted_scores[,c("pca_impulse_omitted", "pca_nonplanning_omitted", "pca_neg_anticipation_omitted")]), type = "pearson")
pca_cor_matrix_omitted

# Merge pca.orthogonal_omitted$scores with survey_data
survey_data_with_pca <- merge(survey_data, pca.orthogonal_omitted_scores, by = "ID")
```

```{r}
# concatenate omega values in a data frame
om_pattern<-grep("omega",names(.GlobalEnv),value=TRUE)
omegas<-do.call("data.frame",mget(om_pattern))
```


```{r get_lists_for_each_prc}
library(stringr)

ctA <- 1;
ctD <- 1;
ctT <- 1;
ctF <- 1;

subListAlc <- matrix(0, length(survey_data$ID), 1)
subListDrug <- matrix(0, length(survey_data$ID), 1)
subListTobac <- matrix(0, length(survey_data$ID), 1)
subListFood <- matrix(0, length(survey_data$ID), 1)


for (s in 1:length(survey_data$ID)) {
  if (survey_data[s,3] == "yes") {
    #probs_alcohol
    subListAlc[ctA,1] <- levels(survey_data$ID)[s]
    subListAlc[ctA,1] <- str_pad(subListAlc[ctA,1], 3, side = "left", pad = 0)
    ctA <- ctA + 1
  }
  if (any(survey_data[s,4:8] == "yes")) {
    #probs_drugs
    subListDrug[ctD,1] <- levels(survey_data$ID)[s]
     subListDrug[ctD,1] <- str_pad(subListDrug[ctD,1], 3, side = "left", pad = 0)
     ctD <- ctD + 1
  }
  if (survey_data[s,9] == "yes") {
    #probs_tobacco
    subListTobac[ctT,1] <- levels(survey_data$ID)[s]
     subListTobac[ctT,1] <- str_pad(subListTobac[ctT,1], 3, side = "left", pad = 0)
     ctT <- ctT + 1
  }
  if (any(survey_data[s,10:15] == "yes")) {
    #probs_food
    subListFood[ctF,1] <- levels(survey_data$ID)[s]
     subListFood[ctF,1] <- str_pad(subListFood[ctF,1], 3, side = "left", pad = 0)
    ctF <- ctF + 1
  }
}

# for (s in 1:length(survey_data$ID)) {
#   if (!is.na(survey_data$weighting_var_alcohol[s])) {
#     subListAlc[ctA,1] <- levels(survey_data$ID)[s]
#     subListAlc[ctA,1] <- str_pad(subListAlc[ctA,1], 3, side = "left", pad = 0)
#     ctA <- ctA + 1
# 
#   }
#   if (!is.na(survey_data$weighting_var_drugs[s])) {
#     subListDrug[ctD,1] <- levels(survey_data$ID)[s]
#     subListDrug[ctD,1] <- str_pad(subListDrug[ctD,1], 3, side = "left", pad = 0)
#     ctD <- ctD + 1
#   }
#   if (!is.na(survey_data$weighting_var_tobacco[s])) {
#     subListTobac[ctT,1] <- levels(survey_data$ID)[s]
#     subListTobac[ctT,1] <- str_pad(subListTobac[ctT,1], 3, side = "left", pad = 0)
#     ctT <- ctT + 1
#   }
#   if (!is.na(survey_data$weighting_var_food[s])) {
#     subListFood[ctF,1] <- levels(survey_data$ID)[s]
#     subListFood[ctF,1] <- str_pad(subListFood[ctF,1], 3, side = "left", pad = 0)
#     ctF <- ctF + 1
#   }
# }

subListAlc <- matrix(subListAlc[subListAlc != 0], ncol = 1)
subListDrug <- matrix(subListDrug[subListDrug != 0], ncol = 1)
subListTobac <- matrix(subListTobac[subListTobac != 0], ncol = 1)
subListFood <- matrix(subListFood[subListFood != 0], ncol = 1)


# setwd('~/Downloads')
# write.table(subListAlc, "subListAlc.txt", sep = "\t", row.names = FALSE, col.names = FALSE)
# write.table(subListDrug, "subListDrug.txt", sep = "\t", row.names = FALSE, col.names = FALSE)
# write.table(subListTobac, "subListTobac.txt", sep = "\t", row.names = FALSE, col.names = FALSE)
# write.table(subListFood, "subListFood.txt", sep = "\t", row.names = FALSE, col.names = FALSE)

lst <- c('a', 'd', 't', 'f')
prcListForVecs <- matrix('_', length(survey_data$ID), 2)

for (s in 1:length(survey_data$ID)) {
  if (survey_data$ID[s] %in% subListAlc) {
    prcListForVecs[s,1] <- paste0(prcListForVecs[s,1],'A')
  }
  if (survey_data$ID[s] %in% subListDrug) {
    prcListForVecs[s,1] <- paste0(prcListForVecs[s,1],'D')
  }
  if (survey_data$ID[s] %in% subListTobac) {
    prcListForVecs[s,1] <- paste0(prcListForVecs[s,1],'T')
  }
  if (survey_data$ID[s] %in% subListFood) {
    prcListForVecs[s,1] <- paste0(prcListForVecs[s,1],'F')
  }
  prcListForVecs[s,2] <- levels(survey_data$ID)[s]
  
}


# Need to manually change '063' from _ATF to _F (filled out alcohol and tobacco in base survey but is only food categories)
prcListForVecs[63,1] <- "_F"


setwd(vecsDir)
write.table(prcListForVecs, "prcListForVecs.txt", sep = "\t", row.names = FALSE, col.names = FALSE)
```

