---
title: "REV Questionnaire Data"
author: "Krista DeStasio"
date: "10/7/2017"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, include=FALSE}
rm(list=ls())
setwd("~/Desktop/REV_scripts/behavioral/surveys")

## Install and load required packages
list.of.packages <- c("stringr", "tidyverse", "reshape2", "ggplot2", "psych", "gridExtra", "knitr", "lme4", "memisc", "withr")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, library, character.only = TRUE)

knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/', echo=TRUE, warning=FALSE, message=FALSE)
```

#Note: The data frame created does not contain all survey data. Will need to create a complete data frame in the future.
### Key:

**Key to variables in the screen_data data frame:**

- Gender: Male = 1, Female = 2  
- Use alcohol: 1 = yes, 2 = no  
- Make tobacco a factor 1 = yes, 2 = no  
- Self-control trouble with drugs: 1 = no, NA with score in subcategory = yes  
- Self-control trouble with food: 1 = no, NA with score in subcategory = yes  


```{r Import qualtrics data}
categories <- as.data.frame(read.table("~/Desktop/REV_scripts/behavioral/REV_SST/info/participantCategories.txt"))
colnames(categories) <- c("ID", "completed.study", "num.categories", "food", "alcohol", "tobacco", "drugs")
categories <- categories[2:145,]

# General survey
gen_survey <- as.data.frame(as.data.set(spss.system.file('~/Dropbox/REV/behavioral_data/questionnaire_data/FromQualtrics/REV_General_Survey.sav')))

# Baseline survey
base_survey <- as.data.frame(as.data.set(spss.system.file('~/Dropbox/REV/behavioral_data/questionnaire_data/FromQualtrics/REV_Baseline_Survey.sav')))

# Screening data
screen_data <- as.data.frame(read.csv('~/Dropbox/REV/behavioral_data/questionnaire_data/FromQualtrics/rev_screening.csv', stringsAsFactors = FALSE, skip = 1))
```

```{r Screening data column names}
colnames(screen_data) = c('responseID', 'responseSet', 'name', 'extData', 'email', 'ip', 'status', 'start', 'end', 'finish', 'scoreSum', 'scoreWeightAvg', 'scoreWeightSD', 'ID', 'screener', 'date', 'instruct1', 'instruct2', 'instruct3', 'instruct4', 'otherStudies', 'ageRange', 'ineligible1', 'englishNative', 'englishFluent', 'ineligible2', 'handedness', 'ineligible3', 'gender', 'pregnant', 'ineligible4', 'instruct5', 'selfControlProblms', 'foods', 'chocolate', 'cookies', 'donuts', 'fries', 'iceCream', 'pasta', 'pizza', 'alcohol', 'tobacco', 'drugs', 'marijuana', 'heroin', 'meth', 'pills', 'cocaine', 'endorsed', 'ineligible5', 'dietRestrict', 'instruct6', 'ineligible6', 'instruct7', 'ineligible7', 'mentalHealth', 'instruct8', 'earlyAdverse', 'ineligible8', 'ineligible9', 'instruct9', 'SSRI', 'ineligible10', 'ineligible11', 'ineligible12', 'instruct10', 'MRI', 'instruct11', 'food1', 'food2', 'food3', 'food4', 'food5', 'alcohol1', 'alcohol2', 'alcohol3', 'alcohol4', 'alcohol5', 'tobacco1', 'tobacco2', 'tobacco3', 'tobacco4', 'tobacco5', 'drugs1', 'drugs2', 'drugs3', 'drugs4', 'drugs5', 'eligible', 'ineligible13', 'enroll', 'lat', 'long', 'acc', 'empty')

# Correct participant IDs (only for participants who were enrolled and later assigned subject IDs)
screen_data[89,14] = '0099'
screen_data[210,14] = '0265'
screen_data[300,14] = '0421'
screen_data[362, 14] = '0489'
screen_data[520, 14] = '0749'
screen_data[583, 14] = '0826'
screen_data[574, 14] = '0854'

# Remove duplicate screening rows (only for participants who were enrolled and later assigned subject IDs)
screen_data <- screen_data[-c(86, 198, 296, 514), ] # 0087, 0246, 0412, 0615
```

```{r Clean phone screening data, include=FALSE}
# Subset the screening data. Drop unneeded columns
screen_data <- dplyr::select(screen_data, scoreSum:enroll, -(contains('ineligible')), -(contains('instruct')), -(contains('Weight')), -(eligible), -(scoreSum))

# Pad the screening IDs with zeros to length four. Missing IDs will become 0000, improperly entered IDs will be corrected (e.g. 90 becomes 0090)
screen_data$ID <- withr::with_options(c(scipen = 999), str_pad(screen_data$ID, 4, pad = "0"))

# Screening IDs of participants who were assigned a study ID
screen_ID <- c('0014', '0016', '0028', '0004', '0012', '0030', '0033', '0011', '0034', '0119', '0139', '0142', '0060', '0041', '0149', '0156', '0083', '0088', '0092', '0115', '0099', '0194', '0130', '0055', '0198', '0183', '0166', '0165', '0180', '0177', '0191', '0218', '0220', '0224', '0246', '0223', '0255', '0286', '0291', '0263', '0261', '0452', '0276', '0280', '0257', '0362', '0243', '0396', '0349', '0265', '0326', '0420', '0329', '0328', '0301', '0338', '0365', '0345', '0357', '0459', '0247', '0421', '0353', '0376', '0381', '0378', '0454', '0380', '0400', '0506', '0479', '0488', '0412', '0515', '0505', '0583', '0493', '0489', '0524', '0513', '0527', '0526', '0540', '0582', '0553', '0638', '0575', '0615', '0596', '0560', '0721', '0610', '0679', '0682', '0686', '0660', '0693', '0087', '0687', '0685', '0661', '0664', '0740', '0749', '0698', '0944', '0735', '0746', '0757', '0826', '0783', '0995', '0779', '0774', '0943', '0802', '0765', '0809', '0797', '0816', '0819', '0868', '0974', '0823', '0837', '0848', '0830', '0854', '1005', '0873', '0967', '0890', '0916', '1013', '0972', '0923', '0983', '0986', '0952', '0985', '1001', '1042', NA, '1002')

# See which IDs are missing from screen_data (used to correct the IDs, should have no mismatches now since IDs corrected)
missing_IDs <- screen_ID[!screen_ID %in% screen_data$ID]

# Only keep data for participants who enrolled
screen_data <- screen_data[screen_data$ID %in% screen_ID, ]

screen_data$ID <- as.factor(screen_data$ID)
#table(screen_data$ID)
```

```{r Clean base survey data}
# Truncate the data set to only columns that contain data
base_survey <- dplyr::select(base_survey, -(v1:v2), -(v4:sc0_2), -(bscs_inst), -(bscs_h_ins), -(audit_inst), -(pacs_instr), -(bscs_inst))

torename <- dplyr::select(base_survey, v3:demo_4)

colnames(torename) <- c('survey_ID', 'ID', 'probs_alcohol', 'probs_cocaine', 'probs_heroin', 'probs_marijuana', 'probs_meth', 'probs_pills', 'probs_tobacco', 'probs_chocolate', 'probs_cookies', 'probs_donuts', 'probs_fries', 'probs_icecream', 'probs_pasta', 'probs_pizza', 'gender', 'age', 'ethnicity', 'handedness')

base_survey <- cbind(torename, dplyr::select(base_survey, -(v3:demo_4)))

# Compare survey ID to manually entered ID & print those that do not match (baseline survey)

base_survey$survey_ID <- gsub("[^0-9]", "", base_survey$survey_ID) 
base_survey$ID <- gsub("[^0-9]", "", base_survey$ID) 

mismatch_ID <- base_survey$survey_ID != base_survey$ID

base_survey<- cbind(mismatch_ID, base_survey)

# See record of all problem IDs and corrections here: https://docs.google.com/spreadsheets/d/1Y9awcY7CsBBBFB1rKMZ_1UfrYxeo3hD9kJEFC58_lQk/edit#gid=368975328

# Correct mismatched participant IDs based on study records 

base_survey[7,2] = '014'
base_survey[9,2] = '013'
base_survey[11,2] = '001'
base_survey[14,2] = '005'
base_survey[43,2] = '050'
base_survey[87,2] = '086'
base_survey[94,2] = '088'
base_survey <- base_survey[-c(77,42,27,10),] # Remove duplicate survey for participants 039,031, 018
base_survey <- base_survey[,-c(1,2)] # drop the mismatch column & redundant survey_ID column

### I ran the below code multiple times while examining the data frame to find the problem IDs:
# Find duplicate manually entered IDs
#dups <-base_survey[duplicated(base_survey$ID)|duplicated(base_survey$ID, fromLast=TRUE),]
#View(dups)

# Find duplicate survey link IDs
#dups_link <-base_survey[duplicated(base_survey$survey_ID)|duplicated(base_survey$survey_ID, fromLast=TRUE),]
#View(dups_link)

base_survey <- merge(categories[,1:2], base_survey, by="ID", all=TRUE)
```

```{r Clean general survey data}
# Truncate the data set to only columns that contain data
gen_survey <- dplyr::select(gen_survey, -(v1:v2), -(v4:v10), -(fhh_inst), -(fhh_inst.0), -(fhh_inst.1), -(fhh_inst.2))

torename <- dplyr::select(gen_survey, v3:fhh_4)

colnames(torename) <- c('survey_ID', 'ID', 'month_born', 'year_born', 'state_born', 'gender', 'ethnicity', 'hispanic', 'education_level')

gen_survey <- cbind(torename, dplyr::select(gen_survey, -(v3:fhh_4)))

# Compare survey ID to manually entered ID & print those that do not match (general survey)

gen_survey$survey_ID <- gsub("[^0-9]", "", gen_survey$survey_ID) 
gen_survey$ID <- gsub("[^0-9]", "", gen_survey$ID) 

mismatch_ID <- gen_survey$survey_ID != gen_survey$ID

gen_survey<- cbind(mismatch_ID, gen_survey)

# See record of all problem IDs and corrections here: https://docs.google.com/spreadsheets/d/1Y9awcY7CsBBBFB1rKMZ_1UfrYxeo3hD9kJEFC58_lQk/edit#gid=368975328

# Correct mismatched participant IDs based on study records 

gen_survey[7,2] = '013'
gen_survey[9,2] = '001'
gen_survey[13,2] = '011'
gen_survey[21,2] = '005'
gen_survey[28,2] = '045'
gen_survey[30,2] = '014'
gen_survey[47,3] = '064'
gen_survey[24,2] = '064'
gen_survey[125,2] = '116'
gen_survey[135,3] = '144'

gen_survey <- gen_survey[-c(8, 14, 55, 39, 66, 146, 112),] # Remove duplicate survey for participants 018, 023, 031, 005, 045, 116, 118

gen_survey <- gen_survey[,-c(1,2)] # drop the mismatch column & redundant survey_ID column

### I ran the below code multiple times while examining the data frame to find the problem IDs:
# Find duplicate manually entered IDs
#dups <-gen_survey[duplicated(gen_survey$ID)|duplicated(gen_survey$ID, fromLast=TRUE),]
#View(dups)

# Find duplicate survey link IDs
#dups_link <-gen_survey[duplicated(gen_survey$survey_ID)|duplicated(gen_survey$survey_ID, fromLast=TRUE),]
#View(dups_link)

gen_survey <- merge(categories[,1:2], gen_survey, by="ID", all=TRUE)
```

```{r Create a single data frame for base and gen surveys}
# Prep gender columns to be combined
gen_survey$gender <- as.character(gen_survey$gender)
base_survey$gender <- as.character(base_survey$gender)

gen_survey <- gen_survey %>% 
    mutate(gender= replace(gender, 
                         which(gender == 'female'), 'Female')) 
gen_survey <- gen_survey %>% 
    mutate(gender= replace(gender, 
                         which(gender == 'male'), 'Male')) 

# Change the values in the ethnicity column to the format used in the base survey so they match
gen_survey$ethnicity <- as.character(gen_survey$ethnicity)
base_survey$ethnicity <- as.character(base_survey$ethnicity)

# For ethnicity columns where ethnicity = white and hispanic = no, White, not of Hispanic Origin
gen_survey <- gen_survey %>% 
    mutate(ethnicity= replace(ethnicity, 
                         which(ethnicity == 'white' & hispanic == 'no'), 'White, not of Hispanic Origin')) 

# For ethnicity columns where ethnicity = white and hispanic = yes, Hispanic
gen_survey <- gen_survey %>% 
    mutate(ethnicity= replace(ethnicity, 
                         which(ethnicity == 'white' & hispanic == 'yes'), 'Hispanic')) 

# White
gen_survey <- gen_survey %>% 
    mutate(ethnicity= replace(ethnicity, 
                         which(ethnicity == 'white'), 'White, not of Hispanic Origin')) 
base_survey <- base_survey %>% 
    mutate(ethnicity= replace(ethnicity, 
                         which(ethnicity == 'white'), 'White, not of Hispanic Origin')) 

# For ethnicity columns where ethnicity = black and hispanic = no, Black, not of Hispanic Origin
gen_survey <- gen_survey %>% 
    mutate(ethnicity= replace(ethnicity, 
                     which(ethnicity == 'black'), 'Black, not of Hispanic Origin')) # No participants "Black, Hispanic" based on base survey responses

gen_survey <- gen_survey %>% 
    mutate(ethnicity= replace(ethnicity, 
                         which(ethnicity == 'american indian'), 'American Indian or Alaskan Native'))

gen_survey <- gen_survey %>% 
    mutate(ethnicity= replace(ethnicity, 
                         which(ethnicity == 'other'), 'Other'))

# Replace missing gender and ethnicity values in the base_survey with those from the general survey
base_survey$ethnicity <- ifelse(test = is.na(base_survey$ethnicity), yes = gen_survey$ethnicity, no = base_survey$ethnicity)

base_survey$gender <- ifelse(test = is.na(base_survey$gender), yes = gen_survey$gender, no = base_survey$gender)

# Create the combined data frame 
survey_data <- merge(base_survey, gen_survey, by=c('ID'), all=TRUE)

survey_data <- rename(survey_data, c("ethnicity.x" = "ethnicity", 
                                     "gender.x" = "gender", 
                                     "completed.study.x" = "completed_study"))

survey_data$ethnicity <- as.factor(survey_data$ethnicity)
survey_data$gender <- as.factor(survey_data$gender)

# Manually enter participants ages calculated based on year/month born and date survey taken
# ID : survey : birth  : age
# 103: 05-2016: 11-1979: 36
# 099: 04-2016: 05-1979: 36
# 096: 04-2016: 09-1961: 54
# 092: 02-2016: 09-1977: 38
# 087: 02-2016: 11-1076: 39
# 083: 01-2016: 11-1978: 37
# 081: 01-2016: 10-1962: 53
# 071: 12-2015: 12-1970: 45
# 061: 12-2015: 02-1980: 35
# 028: 08-2015: 05-1962: 53

survey_data[103, 18] = 36
survey_data[99, 18] = 36
survey_data[96, 18] = 54
survey_data[92, 18] = 38
survey_data[87, 18] = 39
survey_data[83, 18] = 37
survey_data[81, 18] = 53
survey_data[71, 18] = 45
survey_data[61, 18] = 35
survey_data[28, 18] = 53

# Manually enter missing category and gender data based on study notes & phone screening
survey_data[7,c(9,17)] = c(1, "Male") # Male, tobacco
survey_data[28,c(9, 7, 6)] = c(rep(1,3)) # tobacco, meth, marijuana
survey_data[61, c(9, 5, 7)] = c(rep(1,3)) #tobacco, heroin, meth
survey_data[71, c(9:11, 13:16, 6, 3)] = c(rep(1,9)) # chocolate, cookie, ice cream, pasta, pizza, fries, marijuana, alcohol, tobacco
survey_data[081, c(3, 9, 11, 13, 15, 16)] = c(rep(1,6)) #alcohol, tobacco, cookies, fries, pasta, pizza 
survey_data[083, c(9:12, 14:16)] = c(rep(1, 7)) # tobacco, chocolate, cookies, donuts, ice cream, pasta, pizza
survey_data[087, c(3, 14:16, 6)] = c(rep(1, 5)) # alcohol, ice cream, pasta, pizza, Marijuana
survey_data[092, c(6:8, 3)] = c(rep(1,4)) # Marijuana, meth, pills, alcohol
survey_data[096, c(10:14, 16)] = c(rep(1,6)) # chocolate, cookie, donut, fries, ice cream, pizza
survey_data[099, c(11:14, 16, 3, 9, 6, 8)] = c(rep(1,9)) # cookies, donuts, fries, pizza, ice cream, tobacco, alcohol, Marijuana, Pills
survey_data[103, c(6, 9:17)] = c(rep(1, 9), "Male") # Marijuana, chocolate, cookies, donuts, fries, ice cream, pasta, pizza, tobacco
survey_data[139, c(11, 12, 14:17)] = c(rep(1, 5), "Male") # cookies, donuts, ice cream, pasta, pizza

cols <- colnames(dplyr::select(survey_data, starts_with("probs_")))

survey_data[cols] <- sapply(survey_data[cols], as.numeric)

# Add category information to the data frame
survey_data$categories <- as.numeric(categories$num.categories) # The number of major categories the participant endorsed (options were: food, tobacco, drugs, alcohol)

survey_data$subcategories <- rowSums(survey_data[,c(3:16)], na.rm = TRUE) # The total different categories of images a participant saw

survey_data <- survey_data[-143,] # ID 143 was not assigned to a participant

# Make the endorsed categories variables into factors
for(col in cols) {
    survey_data[col][is.na(survey_data[col])] <- 0
}
survey_data[cols] <-
  lapply(survey_data[cols], factor,
         levels = c(0,1),
         labels = c("no", "yes"))

survey_data$completed_study <- 
  factor(survey_data$completed_study, 
         levels = c(0,1),
         labels = c("no","yes"))

survey_data <- dplyr::select(survey_data, -(completed.study.y), -(gender.y:hispanic), -starts_with("location"))
```

## Score the SConS questionnaire
```{r SConS scoring}
## Reverse coding items
scons_cols <- colnames(survey_data[,450:462])
survey_data[scons_cols] <-
      lapply(survey_data[scons_cols], plyr::mapvalues,
      from = c("Not at all 1", "2", "3", "4", "Very Much 5"),
      to = c(1,2,3,4,5))

reverse_cols = c("scons_2", "scons_3", "scons_4", "scons_5", "scons_7", "scons_9", "scons_10", "scons_12", "scons_13")
survey_data[scons_cols] <- 
  lapply(survey_data[scons_cols], as.numeric)
survey_data[,reverse_cols] = 6 - survey_data[,reverse_cols] # Reverse score the SConS items in reverse_cols

survey_data$scons_total <- rowSums(survey_data[scons_cols]) # Total SConS score

# How many survey responses do we have? 114
table(!is.na(survey_data[,"scons_total"]))
```

## Score the BIS questionnaire
```{r BIS soring}
## Reverse coding items
BIS_cols <- colnames(survey_data[,400:429])
survey_data[BIS_cols] <-
      lapply(survey_data[BIS_cols], plyr::mapvalues,
      from = c("Rarely/Never", "Occasionally", "Often", "Almost Always/Always"),
      to = c(1,2,3,4))

reverse_cols = c("bis_7", "bis_13","bis_19","bis_6", "bis_1", "bis_5","bis_8","bis_11", "bis_17", "bis_22", "bis_30")
survey_data[BIS_cols] <- 
  lapply(survey_data[BIS_cols], as.numeric)
survey_data[,reverse_cols] = 5 - survey_data[,reverse_cols] # Reverse score the BIS items in reverse_cols

## Creating the subscales
BISkey_list <- list(attention=c("bis_4","bis_7","bis_10","bis_13","bis_16","bis_19","bis_24","bis_27"), motor=c("bis_2","bis_6","bis_9","bis_12","bis_15","bis_18","bis_21","bis_23","bis_26","bis_29"), non_planning=c("bis_1","bis_3","bis_5","bis_8","bis_11","bis_14","bis_17","bis_20","bis_22","bis_25","bis_28","bis_30"))

survey_data$bis_attn <- rowSums(survey_data[,BISkey_list[[1]]]) # BIS attention score
survey_data$bis_motor <- rowSums(survey_data[,BISkey_list[[2]]]) # BIS motor score
survey_data$bis_noplan <- rowSums(survey_data[,BISkey_list[[3]]]) # BIS non-planning score
survey_data$bis_total <- rowSums(survey_data[,c("bis_attn", "bis_motor", "bis_noplan")]) # BIS total score

# How many survey responses do we have? 116
table(!is.na(survey_data[,"bis_total"]))
```

# Participant Demographics 
(N = 143) enrolled

```{r Screening data descriptives}
kable(as.matrix(psych::describe(screen_data$earlyAdverse)), caption = "Early Adverse Events of Enrolled Participants")
ACES <- screen_data[,c(1,31)]
save(ACES, file = "ACES.Rda")
#colnames(screen_data)
```

```{r Qualtrics demographics}
# Sample size
kable(as.matrix(table(survey_data$completed_study)), caption = "Completed the Study?")

# Get age
kable(as.matrix(psych::describe(survey_data$age)), caption = "Ages, All Participants")
kable(as.matrix(psych::describe(subset(survey_data, completed_study=='yes', select = age))), caption = "Ages, Final Sample")

ggplot(data = survey_data) + 
  geom_bar(mapping = aes(x = age, colour = completed_study)) +
    ggtitle("Participant Attrition by Age")


# Get gender
kable(as.matrix(summary(survey_data$gender)), caption = "Gender, All Participants")
kable(as.matrix(summary(subset(survey_data, completed_study=='yes', select = gender))), caption = "Gender, Final Sample")

# Get cultural/ethnic background
kable(as.matrix(summary(survey_data$ethnicity)), caption = "Ethnic/Cultural Background, All Participants")
kable(as.matrix(summary(subset(survey_data, completed_study=='yes', select = ethnicity))), caption = "Ethnic/Cultural Background, Final Sample")

# How many categories were endorsed by the particpants
kable(as.matrix(psych::describe(survey_data$categories)), caption = "Endorsed Categories, All Participants")
kable(as.matrix(psych::describe(subset(survey_data, completed_study=='yes', select = categories))), caption = "Endorsed Categories, Final Sample")

ggplot(data = survey_data) + 
  geom_bar(mapping = aes(x = categories, colour = completed_study)) +
    ggtitle("Participant Attrition by Number of Categories")

kable(as.matrix(psych::describe(survey_data$subcategories)), caption = "Endorsed Sub-categories, All Participants")
kable(as.matrix(psych::describe(subset(survey_data, completed_study=='yes', select = subcategories))), caption = "Endorsed Sub-categories, Final Sample")

ggplot(data = survey_data) + 
  geom_bar(mapping = aes(x = subcategories, fill = completed_study)) +
    ggtitle("Participant Attrition by Number of Sub-categories")
```